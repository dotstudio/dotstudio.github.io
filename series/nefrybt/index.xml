<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Nefrybt on dotstudio（ドットスタジオ）</title>
    <link>https://dotstud.io/series/nefrybt/</link>
    <description>Recent content in Nefrybt on dotstudio（ドットスタジオ）</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja</language>
    <copyright>© 2018 dotstudio inc.</copyright>
    <lastBuildDate>Mon, 23 Jul 2018 10:00:00 +0900</lastBuildDate>
    <atom:link href="/series/nefrybt/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>【詳細解説】ステッピングモータの仕組みを理解しよう！解説とNefry BTでステッピングモータを使う方法</title>
      <link>https://dotstud.io/blog/stepper-motor-nefrybt-control/</link>
      <pubDate>Mon, 23 Jul 2018 10:00:00 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/stepper-motor-nefrybt-control/</guid>
      
      <description>

&lt;p&gt;モータの種類にはいろいろあります。前回は回転角度を調整できる&lt;a href=&#34;https://dotstud.io/blog/nefry-servo-handson-takudooon/&#34;&gt;サーボモータ&lt;/a&gt;について紹介しました。&lt;/p&gt;



&lt;section class=&#34;link&#34; id=&#34;187&#34;&gt;
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
          &lt;div class=&#34;link_content&#34;&gt;
          &lt;a href=&#34;https://dotstud.io/blog/nefry-servo-handson-takudooon/&#34;&gt;&lt;/a&gt;
          &lt;img src=&#34;https://dotstud.io/img/blog/187/00_thumbnail.png&#34; alt=&#34;サムネイル&#34;&gt;
          &lt;/div&gt;
          &lt;div class=&#34;link_content&#34;&gt;
            &lt;div class=&#34;link_detail&#34;&gt;
              &lt;div class=&#34;link_title&#34;&gt;
                PWM制御をマスターしよう！Node-REDでサーボモータを遠隔制御する方法＆初ハンズオンレポート
              &lt;/div&gt;
              &lt;div class=&#34;link_date&#34;&gt;
                
                2018-07-12
              &lt;/div&gt;
              &lt;div class=&#34;link_desc&#34;&gt;
                PWM制御でサーボモータを操作してモノ作りの幅を広げましょう！Node-REDを使ったハンズオンの内容を紹介します。
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/section&gt;
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
&lt;/section&gt;


&lt;p&gt;今回は、&lt;strong&gt;ロボットアームや3Dプリンタの制御に使われるステッピングモータ&lt;/strong&gt;について説明し、Nefry BTで制御に挑戦してみたいと思います。&lt;/p&gt;

&lt;h2 id=&#34;ステッピングモータとは&#34;&gt;ステッピングモータとは？&lt;/h2&gt;

&lt;p&gt;ステッピングモータは、DCモータ（Direct-current motor、直流電動機）とは異なり、&lt;strong&gt;電力信号を与えることで正確に回転を制御&lt;/strong&gt;できます。&lt;/p&gt;

&lt;p&gt;例えばステッピングモータの使われている3Dプリンタでは、正確に回転を制御できているからこそ3Dプリントが実現しているとも言えます。&lt;/p&gt;

&lt;p&gt;各モータの特徴をまとめると下記のようになります。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;DCモータ: 電力を与えるとずっと回転する&lt;/li&gt;
&lt;li&gt;サーボモータ: ある信号に対応してある角度の範囲で回転する&lt;/li&gt;
&lt;li&gt;ステッピングモータ: 回転範囲に制限はなく、電力信号を与えることで正確に回転し続ける&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;ステッピングモータの種類-１&#34;&gt;ステッピングモータの種類〈１〉&lt;/h3&gt;

&lt;p&gt;ステッピングモータには3種類あります。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;PM型&lt;/strong&gt;（Permanent Magnet Type、永久磁石）

&lt;ul&gt;
&lt;li&gt;回転子として円周上にN極とS極の交互に着磁した磁性体を使用する。安価だが、着磁間隔を細かくすることに限界があり、ステップ角度は小さくできない。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;VR型&lt;/strong&gt;（Variable Reluctance Type、歯車状鉄心形）

&lt;ul&gt;
&lt;li&gt;回転子として歯車状の鉄心を使用する。ステップ角度を小さくできるが、トルクがやや低い。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;HB型&lt;/strong&gt;（Hybrid Type、複合形）

&lt;ul&gt;
&lt;li&gt;PM型とVR型の特徴をもつ構造をしている。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;※回転子（ローター）…モーターとして回転する軸のこと。&lt;/p&gt;

&lt;h3 id=&#34;ステッピングモータの仕組み&#34;&gt;ステッピングモータの仕組み&lt;/h3&gt;

&lt;p&gt;PM型のステッピングモータの仕組みを簡単に説明したいと思います。&lt;/p&gt;

&lt;p&gt;まず、下記の図のようにPM型のステッピングモータは&lt;strong&gt;中心の永久磁石からなる回転子&lt;/strong&gt;と&lt;strong&gt;外側のコイルから構成されている固定子&lt;/strong&gt;から構成されています。コイルに電流を流すことで磁力が発生し、この磁力を利用して回転子を回転させていきます。&lt;/p&gt;





&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/1.png&#34; alt=&#34;1&#34;&gt;

&lt;/center&gt;


&lt;ol&gt;
&lt;li&gt;コイル1に電流を流すと固定子と回転子のN極とS極が引き合う。&lt;/li&gt;
&lt;li&gt;さらにコイル2に電流を流すと、両方の固定子が磁化して回転子を引きつける。つまり45°回転する。&lt;/li&gt;
&lt;li&gt;コイル1の電流を切ると、さらに45°回転する。&lt;/li&gt;
&lt;li&gt;コイル3にコイル1に流した電流と逆方向の電流を流すと、さらに45°回転する。&lt;/li&gt;
&lt;li&gt;コイル2の電流を切ると、さらに45°回転する。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;上記と同様の動作を繰り返すと回転子が回転します。&lt;/p&gt;

&lt;p&gt;また、動画にすると下記のようなイメージです。
&lt;img src=&#34;https://dotstud.io/img/blog/189/2.gif&#34; alt=&#34;&#34; /&gt;
&lt;strong&gt;制御信号（ステップと呼びます）を与えると回転する&lt;/strong&gt;イメージです。また、&lt;strong&gt;1ステップあたりの回転角度を基本ステップ角度&lt;/strong&gt;と呼びます。&lt;/p&gt;

&lt;h3 id=&#34;ステッピングモータの種類-２&#34;&gt;ステッピングモータの種類〈２〉&lt;/h3&gt;

&lt;p&gt;先ほど述べたようにステッピングモータの種類には3種類あります。そして、&lt;strong&gt;さらに2種類&lt;/strong&gt;あります。ただし、この2種類とはステッピングモータ内部にあるコイルへの電流の流し方の違いによるものです。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ユニポーラ型&lt;/strong&gt;（単極性）

&lt;ul&gt;
&lt;li&gt;相電流の切り替えのとき、1つのコイルに対して一定方向の電流しか流さない。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;バイポーラ型&lt;/strong&gt;（双極性）

&lt;ul&gt;
&lt;li&gt;相電流の切り替えのたび、電流の方向が変わる。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;※ステッピングモータの仕組みで説明したように磁極を変えるため内部のコイルをスイッチングする必要がある。その磁極をどのように変更するかというイメージ。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/3.png&#34; alt=&#34;3&#34;&gt;

&lt;/center&gt;
&lt;/p&gt;

&lt;h3 id=&#34;励磁-れいじ-方式&#34;&gt;励磁（れいじ）方式&lt;/h3&gt;

&lt;p&gt;励磁方式とは、簡単に言えば「どのようにコイルに電流を流し、ステッピングモータを回転させるか」です。つまり、どのコイル（どのピン）に電圧をどの順番で印加していくかということです。&lt;/p&gt;

&lt;p&gt;これは、制御するときに方式を選ぶことができます（プログラムで書くことができます）。ライブラリを使って制御するとわかりにくい部分かもしれません。&lt;/p&gt;

&lt;p&gt;大まかに3つの励磁方式があるので、それぞれ紹介したいと思います。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/4.png&#34; alt=&#34;4&#34;&gt;

&lt;/center&gt;
&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;1相励磁&#34;&gt;■ 1相励磁&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;A→B→A&#39;→B&#39;&lt;/code&gt;の順に電流を流します（つまり励磁します）。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/5.png&#34; alt=&#34;5&#34;&gt;

&lt;/center&gt;

このようにパルスを与えるたびに決められてステップ角だけ回転します。励磁の順を&lt;code&gt;A&#39;→B&#39;→A→B&lt;/code&gt;とすると逆回転します。&lt;/p&gt;

&lt;p&gt;1相励磁は最も単純な方式ですが、トルクが弱く高速回転には向いていません。また、安定性が良くないため実用的ではありません｡&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;2相励磁&#34;&gt;■ 2相励磁&lt;/h4&gt;

&lt;p&gt;次の相と1パルスずつずらして同時に励磁する方式です。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/6.png&#34; alt=&#34;6&#34;&gt;

&lt;/center&gt;

パルス幅が1相励磁の2倍となり、1相励磁に比べて回転が安定して、大きなトルクが得られますが消費電力も2倍になります｡&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;1-2相励磁&#34;&gt;■ 1-2相励磁&lt;/h4&gt;

&lt;p&gt;1相励磁と2相励磁を交互に繰り返す方式です。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/7.png&#34; alt=&#34;7&#34;&gt;

&lt;/center&gt;

各相のパルス幅が3となり、次の相とは2パルスだけずらして励磁されます。1パルスごとに回転する角度が1相励磁と2相励磁に比べて半分になり、細かいモータ制御ができます。&lt;strong&gt;基本的にこの励磁方式で制御すれば間違いない&lt;/strong&gt;でしょう。&lt;/p&gt;

&lt;h2 id=&#34;nefry-btでステッピングモータを制御しよう&#34;&gt;Nefry BTでステッピングモータを制御しよう！&lt;/h2&gt;

&lt;h3 id=&#34;ステッピングモータを購入&#34;&gt;ステッピングモータを購入&lt;/h3&gt;

&lt;p&gt;今回は、Amazonで&lt;a href=&#34;https://www.amazon.co.jp/gp/product/B010RYH74U/ref=oh_aui_detailpage_o03_s00?ie=UTF8&amp;amp;psc=1&#34;&gt;こちらのステッピングモータ&lt;/a&gt;を購入して使いました。ステッピングモータとドライバが5セット入っており、それでいて価格が約1000円という激安です。ちょっと試してみるには良い商品かと思います。&lt;/p&gt;

&lt;h4 id=&#34;28byj-48-stepper-motor&#34;&gt;■ 28BYJ-48 Stepper Motor&lt;/h4&gt;





&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/8.png&#34; alt=&#34;8&#34;&gt;

&lt;/center&gt;


&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;uln2003-driver&#34;&gt;■ ULN2003 driver&lt;/h4&gt;





&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/9.png&#34; alt=&#34;9&#34;&gt;

&lt;/center&gt;


&lt;h3 id=&#34;それぞれの仕様&#34;&gt;それぞれの仕様&lt;/h3&gt;

&lt;h4 id=&#34;28byj-48-stepper-motor-1&#34;&gt;■ 28BYJ-48 Stepper Motor&lt;/h4&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;概要&lt;/th&gt;
&lt;th&gt;仕様&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;種類&lt;/td&gt;
&lt;td&gt;ユニポーラ型&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;結線&lt;/td&gt;
&lt;td&gt;5線式&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;電圧&lt;/td&gt;
&lt;td&gt;5-12V（直流電圧）&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;周波数&lt;/td&gt;
&lt;td&gt;100 Hz&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;ステップモード&lt;/td&gt;
&lt;td&gt;ハーフステップモード（推奨）（8ステップの信号で制御）&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;ステップ角&lt;/td&gt;
&lt;td&gt;ハーフステップモード：64ステップで5.625°回転&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;ギア比&lt;/td&gt;
&lt;td&gt;64:1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;※ギア比…2つの歯車（ギア）の歯数の比率のこと。自転車をイメージすると良い。&lt;br /&gt;
※ハーフステップモード…ステップ角が基本ステップ角度の1/2の角度で駆動する方式。&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;uln2003-driver-1&#34;&gt;■ ULN2003 driver&lt;/h4&gt;

&lt;p&gt;ステッピングモータを使う際には、&lt;strong&gt;ステッピングモータ用のドライバ&lt;/strong&gt;を使用します。マイコンボードの信号だけでは制御できないので、制御を補助するためのものです。&lt;/p&gt;

&lt;p&gt;1-2相励磁で制御する場合は、下記のような信号の組み合わせになります。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/10.png&#34; alt=&#34;10&#34;&gt;

&lt;/center&gt;

（参照：&lt;a href=&#34;http://eeshop.unl.edu/pdf/Stepper+Driver.pdf&#34;&gt;http://eeshop.unl.edu/pdf/Stepper+Driver.pdf&lt;/a&gt; ）&lt;/p&gt;

&lt;p&gt;このステッピングモータでは8ステップで1つの動作を表しています。つまり、8ステップ×8ステップ=64ステップで5.625°回転します。よって1回転するには360°÷5.625°×64=4096ステップで1回転します。&lt;/p&gt;

&lt;h3 id=&#34;回路&#34;&gt;回路&lt;/h3&gt;

&lt;p&gt;Nefry BTとステッピングモータの回路は下記のようになります。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/11.png&#34; alt=&#34;11&#34;&gt;

&lt;/center&gt;

今回、使用するステッピングモータは5~12Vの間で動作します。また、Nefry BTとステッピングモータの電源は分けて使います。&lt;/p&gt;

&lt;h3 id=&#34;プログラム-ライブラリあり&#34;&gt;プログラム（ライブラリあり）&lt;/h3&gt;

&lt;p&gt;プログラムは下記の通りです。&lt;/p&gt;

&lt;p&gt;Nefry BT上のスイッチを押すとステッピングモータが180°回転するというものです。今回は、ステッピングモータを回転させるため「Stepper.h」ライブラリを使いました。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;// ステッピングモータとNefry BTを制御するためのライブラリをinclude
#include &amp;lt;Stepper.h&amp;gt;
#include &amp;lt;Nefry.h&amp;gt;

/*
・フルステップ方式で2相励磁の場合は1つの動作で4ステップ
・8回繰り返す（4×8 = 32ステップ）で11.25度回転
・つまり、360度回転しようとするとき360/11.25 = 32ステップ
・ギア比を考慮して32×64 = 2048ステップ
・よって、ハフルステップ方式で2相励磁の場合、2048ステップで1回転
*/

/*
・ハーフステップ方式で1-2相励磁の場合は1つの動作で8ステップ
・8回繰り返す（8×8 = 64ステップ）と5.625度回転
・つまり、360度回転しようとすると360/5.625 = 64ステップ
・ギア比を考慮して64×64 = 4096ステップ
・よって、ハーフステップ方式で1-2相励磁の場合、4096ステップで1回転
*/

#define MOTOR_1   D2   // blue
#define MOTOR_2   D3   // pink
#define MOTOR_3   D4   // yellow
#define MOTOR_4   D5   // orange

// ステッピングモータが1回転するのに必要なステップ数を定義
#define MOTOR_STEPS 2048

Stepper myStepper(MOTOR_STEPS, MOTOR_1, MOTOR_2, MOTOR_3, MOTOR_4);

void setup() {
    // setspeed()関数でrpm（1分あたりの回転数）を設定
    // 例：10rpm=10回転/分
    myStepper.setSpeed(10);//10回転/分
}

void loop() {
    if(Nefry.readSW()){
        // 1024ステップ回転、つまり180°回転
        myStepper.step(1024);
    }
    // 静止時の負荷がないので電流を止める
    stopMotor();
}

// モーターへの電流を止める
void stopMotor() {
    digitalWrite(MOTOR_1, LOW);
    digitalWrite(MOTOR_2, LOW);
    digitalWrite(MOTOR_3, LOW);
    digitalWrite(MOTOR_4, LOW);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;動かしてみると&#34;&gt;動かしてみると&lt;/h3&gt;

&lt;p&gt;実際に動かしてみると、180°回転していることがわかります。
&lt;img src=&#34;https://dotstud.io/img/blog/189/12.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;プログラム-ライブラリなし&#34;&gt;プログラム（ライブラリなし）&lt;/h3&gt;

&lt;p&gt;ステッピングモータの仕組みを理解する場合、ライブラリなしの方がわかりやすいかと思います。&lt;/p&gt;

&lt;p&gt;下記はライブラリを使わずに励磁方式を変えてステッピングモータを制御したプログラムです。先ほど示した励磁方式の図を見ながら理解すると、良くわかるかと思います。&lt;/p&gt;

&lt;p&gt;今回、使用するドライバには各相に対応してLEDが点灯するので、どの相に電圧を印加したかわかりやすいですね。&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;1相励磁-1&#34;&gt;■ 1相励磁&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;#include&amp;lt;Nefry.h&amp;gt;

// 任意のピンを設定してください。基本、デジタルピンでOKです。都合上A2,A3を使っています。
#define PIN1 A2
#define PIN2 A3
#define PIN3 D3
#define PIN4 D4

void setup()
{

  Serial.begin(115200);

  pinMode(PIN1, OUTPUT);      // PIN1を出力モードにする
  pinMode(PIN2, OUTPUT);      // PIN2を出力モードにする
  pinMode(PIN3, OUTPUT);      // PIN3を出力モードにする
  pinMode(PIN4, OUTPUT);      // PIN4を出力モードにする
}

void loop()
{
  int sleep_time = 300;       // スリープ時間[ms]、時間を短くすると回転速度上昇

  digitalWrite(PIN1, 1);    
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 1);
  digitalWrite(PIN4, 0);
  delay(sleep_time);    

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 1);
  delay(sleep_time);

  // 電流を流し続けると発熱するのでいったん止める
  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/189/13.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;2相励磁-1&#34;&gt;■ 2相励磁&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;#include&amp;lt;Nefry.h&amp;gt;

#define PIN1 A2
#define PIN2 A3
#define PIN3 D3
#define PIN4 D4

void setup()
{
  Serial.begin(115200);

  pinMode(PIN1, OUTPUT);
  pinMode(PIN2, OUTPUT);
  pinMode(PIN3, OUTPUT);
  pinMode(PIN4, OUTPUT);
}

void loop()
{

  int sleep_time = 5;

  digitalWrite(PIN1, 1);    
  digitalWrite(PIN2, 1);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 1);
  digitalWrite(PIN3, 1);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 1);
  digitalWrite(PIN4, 1);
  delay(sleep_time);

  digitalWrite(PIN1, 1);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 1);
  delay(sleep_time);

  // 電流を流し続けると発熱するのでいったん止める
  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/189/14.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;1-2相励磁-1&#34;&gt;■ 1-2相励磁&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;#include&amp;lt;Nefry.h&amp;gt;

#define PIN1 A2
#define PIN2 A3
#define PIN3 D3
#define PIN4 D4

void setup()
{
  Serial.begin(115200);

  pinMode(PIN1, OUTPUT);
  pinMode(PIN2, OUTPUT);
  pinMode(PIN3, OUTPUT);
  pinMode(PIN4, OUTPUT);
}

void loop()
{
  int sleep_time = 5;

  digitalWrite(PIN1, 1);    
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 1);
  digitalWrite(PIN2, 1);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 1);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 1);
  digitalWrite(PIN3, 1);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 1);
  digitalWrite(PIN4, 0);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 1);
  digitalWrite(PIN4, 1);
  delay(sleep_time);

  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 1);
  delay(sleep_time);

  digitalWrite(PIN1, 1);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 1);
  delay(sleep_time);

  //電流を流し続けると発熱するのでいったん止める
  digitalWrite(PIN1, 0);
  digitalWrite(PIN2, 0);
  digitalWrite(PIN3, 0);
  digitalWrite(PIN4, 0);
  delay(sleep_time);
}


&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/189/15.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;作例-xy軸ステージ&#34;&gt;作例: xy軸ステージ&lt;/h2&gt;

&lt;p&gt;ステッピングモータを使えば、3Dプリンタの軸に使われているような可動式のステージを自作することも可能です。&lt;/p&gt;

&lt;p&gt;たとえば、下記が自作したxy軸の2軸ステージです。また、これはNode-REDで遠隔制御できるようにしています。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/189/16.png&#34; alt=&#34;16&#34;&gt;

&lt;/center&gt;
&lt;/p&gt;

&lt;h2 id=&#34;おわりに&#34;&gt;おわりに&lt;/h2&gt;

&lt;p&gt;モータの世界はまだまだ奥深いのですが、今回はここまでです。&lt;/p&gt;

&lt;p&gt;ステッピングモータが使えれば、さらにモノづくりの幅が広がることでしょう。また、IoT向きの開発ボードNefry BTを使えば、&lt;strong&gt;遠隔制御できる「何か」&lt;/strong&gt;を割と簡単に作ることができます。&lt;/p&gt;

&lt;h2 id=&#34;参考サイト&#34;&gt;参考サイト&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://42bots.com/tutorials/28byj-48-stepper-motor-with-uln2003-driver-and-arduino-uno/&#34;&gt;28BYJ-48 Stepper Motor with ULN2003 driver and Arduino Uno |  42 Bots&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://toshiba.semicon-storage.com/jp/design-support/e-learning/stepping_motor/chap3/1274646.html&#34;&gt;励磁モードまとめ | TOSHIBA e-ラーニング&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>PWM制御をマスターしよう！Node-REDでサーボモータを遠隔制御する方法＆初ハンズオンレポート</title>
      <link>https://dotstud.io/blog/nefry-servo-handson-takudooon/</link>
      <pubDate>Thu, 12 Jul 2018 10:00:00 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/nefry-servo-handson-takudooon/</guid>
      
      <description>

&lt;h2 id=&#34;暑さ本番-いよいよ大好きな生ビールの季節がやってまいりました&#34;&gt;暑さ本番、いよいよ大好きな生ビールの季節がやってまいりました！&lt;/h2&gt;

&lt;p&gt;みなさまいかがお過ごしでしょうか？どうも、宇宙エンジニアの&lt;a href=&#34;https://dotstud.io/members/takudooon&#34;&gt;たくろーどん&lt;/a&gt;です。毎日、暑いですね。&lt;/p&gt;

&lt;p&gt;さて先日、&lt;strong&gt;初めてハンズオンイベント&lt;/strong&gt;を企画・実施してみました！題して、「&lt;a href=&#34;https://dotstudio.connpass.com/event/91695/&#34;&gt;&lt;strong&gt;【IoT】PWM制御をマスター！Nefry BT+Node-REDでサーボモータを遠隔制御&lt;/strong&gt;&lt;/a&gt;」！&lt;/p&gt;

&lt;p&gt;「モノづくりをしたい！」「こんなものをつくりたい！」と思っても「&lt;strong&gt;こういう技術がつかえる&lt;/strong&gt;」ということを知らないと、なかなかモノづくりが進みません。&lt;/p&gt;

&lt;p&gt;なので、動くものを作りたいときに便利な&lt;u&gt;&lt;strong&gt;サーボモータとその制御方法であるPWM制御&lt;/strong&gt;をマスターし、&lt;strong&gt;PCからサーボモータを遠隔制御をしよう&lt;/strong&gt;&lt;/u&gt;というのがハンズオンの目論見です。&lt;/p&gt;

&lt;p&gt;では、ちらっとハンズオンの内容を振り返ってみたいと思います。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/187/1.png&#34; alt=&#34;1&#34;&gt;

&lt;/center&gt;
&lt;/p&gt;

&lt;h2 id=&#34;pwm制御を用いたプログラムの書き方&#34;&gt;PWM制御を用いたプログラムの書き方&lt;/h2&gt;

&lt;h3 id=&#34;pwm制御について&#34;&gt;PWM制御について&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://dotstud.io/docs/pulse-width-modulation/&#34;&gt;PWM制御の大まかな説明&lt;/a&gt;は以前、ドキュメントに書きました。ようするに、PWM制御は「&lt;strong&gt;パルスのオン・オフ繰り返し切り替えることで出力される電力を制御&lt;/strong&gt;」するという意味です。&lt;/p&gt;

&lt;p&gt;でも結局のところ、「&lt;strong&gt;PWM制御ってどんなイメージやねん！&lt;/strong&gt;」と多くの方が思うでしょう。&lt;/p&gt;

&lt;p&gt;なので、これがわかりやすいのではないかという説明を思いつきました。それが、下記の動画です。
&lt;img src=&#34;https://dotstud.io/img/blog/187/2.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;例えば、自宅から最寄りの駅まで走らなければならない状況を考えます。まるで、小学校の算数にでてくるたかしくんの問題を彷彿させますね。知らんけど。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;100%の力で走れば5分で駅につく ≒ 100%出力されるので、5V出力される&lt;/li&gt;
&lt;li&gt;全力で走って途中で歩くと9分で駅に着く（全体的に80%の力で走る） ≒ 80%出力されるので、4V出力される&lt;/li&gt;
&lt;li&gt;全力で走って途中で歩くと10分で駅に着く（全体的に50%の力で走る） ≒ 50%出力されるので、2.5V出力される&lt;/li&gt;
&lt;li&gt;全力で走って途中で歩くと15分で駅に着く（全体的に10%の力で走る） ≒ 10%出力されるので、0.5V出力される&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;というようなイメージです。自宅から駅まで走る場合は走る速さの具合によって、到着時間が伸びます。しかし、電圧の場合は実行電圧（実際に出力される電圧）は下がっていきます。&lt;/p&gt;

&lt;h3 id=&#34;esp32開発ボードでのプログラムについて&#34;&gt;ESP32開発ボードでのプログラムについて&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://dotstud.io/docs/nefrybt&#34;&gt;Nefry BT&lt;/a&gt;のようなESP32を搭載しているような開発ボードでPWM制御する場合は、ledc関数を使います。&lt;strong&gt;ESP32ではArduinoでつかうようなanalogWrite関数が実装されていない&lt;/strong&gt;とのことなので注意しましょう（ただし、今後変更される可能性があります）。&lt;/p&gt;

&lt;p&gt;例えば、下記のようなプログラムになります。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;
//基本Iotは2.4GHz帯を使うこと
#include&amp;lt;Nefry.h&amp;gt;
#include&amp;quot;esp32-hal-ledc.h&amp;quot;

//PWM信号の周波数をPWMをつくっているクロック周波数で割ったもの
//ledcSetupでPWMの範囲を8bitに設定したとき、0～255　10bitのときは0～1023となる、2進数の話
#define PWM_BITWIDTH 16

//わかりやすいように角度に変換する関数/////////////////////
int deg2pw(int deg, int bit){
    double ms = ((double) deg - 90.0) * 0.95 / 90.0 + 1.45;
    return (int) (ms / 20.0 * pow(2, bit));
}
//////////////////////////////////////////////////////////

void setup() {
  Serial.begin(115200);
//ledcSetup(チャンネル数(0～),周波数(たとえばPWMサイクル20mHzなら50Hzになるという意味(SG90の場合))、分解能は任意(ただし限度はある))
  ledcSetup(0,50,PWM_BITWIDTH);
  ledcAttachPin(ピン番号,0);//left_motor
  Nefry.enableSW();
}

void loop(){
   if((Nefry.readSW())){
      ledcWrite(0,deg2pw(90, PWM_BITWIDTH));
      delay(800);
      ledcWrite(0,deg2pw(0, PWM_BITWIDTH));
   }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;プログラムの書き方&#34;&gt;プログラムの書き方&lt;/h3&gt;

&lt;p&gt;プログラムを詳しく見てましょう。&lt;/p&gt;

&lt;p&gt;ledc関数を使うため、ライブラリ「esp32-hal-ledc.h」を最初にインクルードします。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;#include&amp;quot;esp32-hal-ledc.h&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ライブラリ「esp32-hal-ledc.h」を使うときの主な関数は以下に示すものです。&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;ledcSetup（チャンネル,周波数,分解能）&lt;/li&gt;
&lt;li&gt;ledcAttachPin（ピン番号,チャンネル）：チャンネルはピン番号の識別番号です&lt;/li&gt;
&lt;li&gt;ledcWrite（チャンネル,パルス幅）：設定した角度になるように与えるべきパルス幅を算出する関数&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;実際の記述は以下のようになります。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;void setup() {
    Serial.begin(115200);
    ledcSetup(0,50,PWM_BITWIDTH);
    ledcAttachPin(A2,0);//left_motor
    Nefry.enableSW();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;分解能は&lt;strong&gt;どれだけ細かく制御するのか&lt;/strong&gt;を表しているイメージです。これは&lt;strong&gt;ビット数&lt;/strong&gt;で表します。&lt;/p&gt;

&lt;p&gt;例えば、分解能を&lt;strong&gt;8ビットとするれば0〜255バイト&lt;/strong&gt;（2の8乗）、&lt;strong&gt;10ビットなら0〜1023バイト&lt;/strong&gt;（2の10乗）となります。&lt;/p&gt;

&lt;p&gt;これを、どのようにPWM制御に使えるのか説明します。PWM制御とは一定電圧の入力から&lt;strong&gt;パルス列のオンとオフの一定周期を作り、オンの時間幅を変化させる電力制御方式&lt;/strong&gt;のことです。つまり、&lt;strong&gt;実効電圧を変化させる&lt;/strong&gt;ことができます。&lt;/p&gt;

&lt;p&gt;なので、例えば、最大5[V]の出力を考えたとき、&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;分解能8ビットだと0→0[V]、127→2.5[V]、255→5[V]&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;分解能10ビットだと0→0[V]、511→2.5[V]、1023→5[V]&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;と表せます。分解能が大きい方が、細かい制御ができることがわかるかと思います。&lt;/p&gt;

&lt;h2 id=&#34;node-red-mqttでサーボモータを遠隔制御&#34;&gt;Node-RED×MQTTでサーボモータを遠隔制御&lt;/h2&gt;

&lt;h3 id=&#34;node-redとは&#34;&gt;Node-REDとは&lt;/h3&gt;

&lt;p&gt;



&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/187/9.png&#34; alt=&#34;9&#34;&gt;

&lt;/center&gt;

&lt;a href=&#34;https://nodered.jp/&#34;&gt;Node-RED&lt;/a&gt;はハードウェアデバイス/APIおよびオンラインサービスを接続するためのツールです。ウェブ上で、フローチャートのように直感的にプログラムをつくることができます。そして、最終的に自分が欲しい仕組みを作り上げるというものです。&lt;/p&gt;

&lt;p&gt;Node-REDを使うには大まかに2パターンあります。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;自分のPC上でローカルで動かす（今回はこちらで進めていきます）&lt;/li&gt;
&lt;li&gt;外部のサービスを利用する（IBMクラウドやenebularなど）&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;導入方法は、&lt;a href=&#34;https://qiita.com/minwinmin/private/6c13d2c912d0d7e8e197&#34;&gt;こちら&lt;/a&gt;で説明していますので参考にしてください。&lt;/p&gt;

&lt;p&gt;また、後ほどNode-REDにフローのコードを貼り付ける必要があるので簡単に貼り付け方法を説明します。&lt;/p&gt;

&lt;p&gt;まずフローのコードをコピーし、Node-REDを立ち上げたら右上のメニュー（3本線）をクリックします。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/187/10.png&#34; alt=&#34;10&#34;&gt;

&lt;/center&gt;

すると上記のような画面があらわれます。「読み込み」をクリックして、あらわれた画面にコピーしたコードを貼り付ければ完了です。&lt;/p&gt;

&lt;h3 id=&#34;mqttとは&#34;&gt;MQTTとは&lt;/h3&gt;

&lt;p&gt;MQTTとは、&lt;strong&gt;多数のデバイスの間で短いメッセージを頻繁に送受信する&lt;/strong&gt;ことを想定した通信プロトコルです。つまりインフラのようなもの、もしくはメッセージを送受信するので土管のようなものをイメージすると良いかと思います。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/187/3.png&#34; alt=&#34;3&#34;&gt;

&lt;/center&gt;
&lt;/p&gt;

&lt;p&gt;MQTTは先ほど説明したような仕組みの名前です。なので、実際にメッセージを送受信するためにはMQTTブローカーが必要です。イメージは下記の画像のようになります。




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/187/4.png&#34; alt=&#34;4&#34;&gt;

&lt;/center&gt;

MQTTブローカーを用意するには、いくつか方法があります（&lt;a href=&#34;http://acro-engineer.hatenablog.com/entry/2015/06/19/120000&#34;&gt;こちらのサイト&lt;/a&gt;にまとめられています）。今回、ハンズオンでつかったの以下の2パターンです。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ローカルホストでMQTTブローカーをたてる&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mcollina/mosca&#34;&gt;Mosca&lt;/a&gt;を利用する -&amp;gt; MQTT brokerのためのライブラリ（IBMクラウドのような外部サービスでNode-REDを使う場合、うまくいきませんでした）&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://test.mosquitto.org/&#34;&gt;mosquitto&lt;/a&gt;のテストサーバーを利用する&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;これから記載するプログラムはこちらを使っています。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;node-redのフローのコード&#34;&gt;Node-REDのフローのコード&lt;/h3&gt;

&lt;p&gt;下記のNode-REDのフローのコードを、Node-REDにコピーして使いましょう。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[
    {
        &amp;quot;id&amp;quot;: &amp;quot;7878093f.d68778&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;debug&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;active&amp;quot;: true,
        &amp;quot;tosidebar&amp;quot;: true,
        &amp;quot;console&amp;quot;: false,
        &amp;quot;tostatus&amp;quot;: false,
        &amp;quot;complete&amp;quot;: &amp;quot;payload&amp;quot;,
        &amp;quot;x&amp;quot;: 522.0130081176758,
        &amp;quot;y&amp;quot;: 161.99999809265137,
        &amp;quot;wires&amp;quot;: []
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;22ca4d97.8e3382&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;inject&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;topic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;payload&amp;quot;: &amp;quot;{\&amp;quot;motor\&amp;quot;:1}&amp;quot;,
        &amp;quot;payloadType&amp;quot;: &amp;quot;json&amp;quot;,
        &amp;quot;repeat&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;crontab&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;once&amp;quot;: false,
        &amp;quot;onceDelay&amp;quot;: 0.1,
        &amp;quot;x&amp;quot;: 220.01303100585938,
        &amp;quot;y&amp;quot;: 244.00000190734863,
        &amp;quot;wires&amp;quot;: [
            [
                &amp;quot;6b18ace.785b854&amp;quot;
            ]
        ]
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;6b18ace.785b854&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;mqtt out&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;/sub/NefryBT/SAMPLE&amp;quot;,
        &amp;quot;topic&amp;quot;: &amp;quot;/sub/NefryBT/SAMPLE&amp;quot;,
        &amp;quot;qos&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;retain&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;broker&amp;quot;: &amp;quot;3890dddf.26f532&amp;quot;,
        &amp;quot;x&amp;quot;: 508.0130386352539,
        &amp;quot;y&amp;quot;: 293.9999957084656,
        &amp;quot;wires&amp;quot;: []
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;e0581ff4.bce8a&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;inject&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;topic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;payload&amp;quot;: &amp;quot;{\&amp;quot;motor\&amp;quot;:0}&amp;quot;,
        &amp;quot;payloadType&amp;quot;: &amp;quot;json&amp;quot;,
        &amp;quot;repeat&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;crontab&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;once&amp;quot;: false,
        &amp;quot;onceDelay&amp;quot;: 0.1,
        &amp;quot;x&amp;quot;: 220.01303100585938,
        &amp;quot;y&amp;quot;: 344.00000190734863,
        &amp;quot;wires&amp;quot;: [
            [
                &amp;quot;6b18ace.785b854&amp;quot;
            ]
        ]
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;3dccf617.5970da&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;mqtt in&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;topic&amp;quot;: &amp;quot;/sub/NefryBT/SAMPLE&amp;quot;,
        &amp;quot;qos&amp;quot;: &amp;quot;2&amp;quot;,
        &amp;quot;broker&amp;quot;: &amp;quot;cd2e6f9.ab8069&amp;quot;,
        &amp;quot;x&amp;quot;: 235.09634399414062,
        &amp;quot;y&amp;quot;: 159.3697967529297,
        &amp;quot;wires&amp;quot;: [
            [
                &amp;quot;7878093f.d68778&amp;quot;
            ]
        ]
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;f5c8b0fb.93d8&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;comment&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;Node-RED上に文字列表示&amp;quot;,
        &amp;quot;info&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;x&amp;quot;: 237.09635162353516,
        &amp;quot;y&amp;quot;: 114.08594131469727,
        &amp;quot;wires&amp;quot;: []
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;47872155.bfb16&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;comment&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;MQTTブローカー側に文字列を送信&amp;quot;,
        &amp;quot;info&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;x&amp;quot;: 265.0130310058594,
        &amp;quot;y&amp;quot;: 206.0104217529297,
        &amp;quot;wires&amp;quot;: []
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;d5a5e79d.ec27a8&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;comment&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;MQTTブローカー側に文字列を送信するためのフロー&amp;quot;,
        &amp;quot;info&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;x&amp;quot;: 609.0130004882812,
        &amp;quot;y&amp;quot;: 257.0104160308838,
        &amp;quot;wires&amp;quot;: []
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;3700aeb9.5a7ec2&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;comment&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;782bda22.769d84&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;ｍosquittoのテストサーバーを利用&amp;quot;,
        &amp;quot;info&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;x&amp;quot;: 265.0130310058594,
        &amp;quot;y&amp;quot;: 52.010416984558105,
        &amp;quot;wires&amp;quot;: []
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;3890dddf.26f532&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;mqtt-broker&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;broker&amp;quot;: &amp;quot;http://test.mosquitto.org/&amp;quot;,
        &amp;quot;port&amp;quot;: &amp;quot;1883&amp;quot;,
        &amp;quot;clientid&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;usetls&amp;quot;: false,
        &amp;quot;compatmode&amp;quot;: true,
        &amp;quot;keepalive&amp;quot;: &amp;quot;60&amp;quot;,
        &amp;quot;cleansession&amp;quot;: true,
        &amp;quot;birthTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;birthQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;birthPayload&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;closeTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;closeQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;closePayload&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;willTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;willQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;willPayload&amp;quot;: &amp;quot;&amp;quot;
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;cd2e6f9.ab8069&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;mqtt-broker&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;broker&amp;quot;: &amp;quot;http://test.mosquitto.org/&amp;quot;,
        &amp;quot;port&amp;quot;: &amp;quot;1883&amp;quot;,
        &amp;quot;clientid&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;usetls&amp;quot;: false,
        &amp;quot;compatmode&amp;quot;: true,
        &amp;quot;keepalive&amp;quot;: &amp;quot;60&amp;quot;,
        &amp;quot;cleansession&amp;quot;: true,
        &amp;quot;birthTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;birthQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;birthPayload&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;closeTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;closeQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;closePayload&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;willTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;willQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;willPayload&amp;quot;: &amp;quot;&amp;quot;
    }
]
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;nefry-btのプログラム&#34;&gt;Nefry BTのプログラム&lt;/h3&gt;

&lt;p&gt;下記がNefry BT側のプログラムになります。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;//Nefryがwifiにつながっているか確認、2.4Ghzにつなごう
//できたtest.mosquitto.orgで使える！
#include &amp;lt;Nefry.h&amp;gt;
#include &amp;lt;WiFiClient.h&amp;gt;
#include &amp;lt;PubSubClient.h&amp;gt;
#include &amp;lt;ArduinoJson.h&amp;gt;
#include&amp;quot;esp32-hal-ledc.h&amp;quot;
#define URL &amp;quot;mosquitto.org&amp;quot;

#define PWM_BITWIDTH 16

int deg2pw(int deg, int bit){
    double ms = ((double) deg - 90.0) * 0.95 / 90.0 + 1.45;
    return (int) (ms / 20.0 * pow(2, bit));
}

IPAddress endpoint;
const int port = 1883;

const char *pubTopic;
const char *subTopic;
const char *deviceName;
const char *mqtt_server = &amp;quot;test.mosquitto.org&amp;quot;;

WiFiClient httpsClient;
PubSubClient mqttClient(httpsClient);



void setup() {
  ledcSetup(0,50,PWM_BITWIDTH);
  ledcAttachPin(A2,0);

  //// NefryBT設定画面まわり ////////////////////////////////////////

  // NefryBT
  pubTopic = &amp;quot;/pub/NefryBT/SAMPLE&amp;quot;;
  subTopic = &amp;quot;/sub/NefryBT/SAMPLE&amp;quot;;
  deviceName = &amp;quot;NefryBT_SAMPLE&amp;quot;;  // 複数台で利用する場合は必ずかぶらないように変更する
  // ローカルホストでMQTTブローカーを立てている場合は、パソコンのIPAddress型に収納。配列っぽく入れる。ここはその都度確認すること
  //endpoint指定部
  endpoint[0] = 192;
  endpoint[1] = 168;
  endpoint[2] = 43;
  endpoint[3] = 105;

  //// 以下通常処理 ////////////////////////////////////////

  Serial.begin(115200);
  //mqttClient.setServer()関数でMQTTブローカーを指定する
  mqttClient.setServer(mqtt_server, port);
  mqttClient.setCallback(mqttCallback);

  connectMQTT();
}

//MQTTがちゃんと動いているか、つながっているかを判断  
void connectMQTT() {
    Serial.println(&amp;quot;connectMQTT&amp;quot;);
    Serial.println(deviceName);
    while (!mqttClient.connected()) {
      Serial.print(&amp;quot;.&amp;quot;);
        if (mqttClient.connect(deviceName)) {
            Serial.println(&amp;quot;Connected.&amp;quot;);
            int qos = 0;
            mqttClient.subscribe(subTopic, qos);
            Serial.println(&amp;quot;Subscribed.&amp;quot;);
        } else {
            Serial.print(&amp;quot;Failed. Error state=&amp;quot;);
            Serial.print(mqttClient.state());
            // Wait 5 seconds before retrying
            delay(5000);
        }
    }
}
///////////////////////////////////////////////////////

char pubMessage[128];

void mqttCallback (char* topic, byte* payload, unsigned int length) {

    String str = &amp;quot;&amp;quot;;
    Serial.print(&amp;quot;Received. topic=&amp;quot;);
    Serial.println(topic);
    for (int i = 0; i &amp;lt; length; i++) {
        Serial.print((char)payload[i]);
        str += (char)payload[i];
    }
    Serial.print(&amp;quot;\n&amp;quot;);

    StaticJsonBuffer&amp;lt;200&amp;gt; jsonBuffer;

    JsonObject&amp;amp; root = jsonBuffer.parseObject(str);

    // 読み取った文字列をパース
    if (!root.success()) {
      Serial.println(&amp;quot;parseObject() failed&amp;quot;);
      return;
    }
//Node-REDから文字列を読み取ってくる部分//////
    const char* message = root[&amp;quot;message&amp;quot;];
    int motor = root[&amp;quot;motor&amp;quot;];
////////////////////////////////////////////
    Serial.print(&amp;quot;motor = &amp;quot;);
    Serial.println(motor);
///サーボモータを動かす処理//////////////////
    if( motor == 1 ){
       for(int i=90; i&amp;lt;=115; i++){
          ledcWrite(0,deg2pw(i, PWM_BITWIDTH));
       }
       delay(800);
       ledcWrite(0,deg2pw(90, PWM_BITWIDTH));
    } else {
       for(int i=90; i&amp;gt;=65; --i){//0～180°の位置で考える、90度が基準点としてそこからどう動くかを考える
          ledcWrite(0,deg2pw(i, PWM_BITWIDTH));
       }
       delay(800);
       ledcWrite(0,deg2pw(90, PWM_BITWIDTH));
    }

    Nefry.ndelay(1000);

}
//////////////////////////////////////////////

//mqttを動かしている部分///////////////////////  
void mqttLoop() {
    if (!mqttClient.connected()) {
        connectMQTT();
    }
    mqttClient.loop();
}

void loop() {
  mqttLoop();
 }
//////////////////////////////////////////////

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;動作させてみると&#34;&gt;動作させてみると……&lt;/h3&gt;

&lt;p&gt;このように、PC上から遠隔でサーボモータを制御できるようになります。
&lt;img src=&#34;https://dotstud.io/img/blog/187/5.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;node-red-mqttでサーボモータをui-ブラウザ-から制御&#34;&gt;Node-RED×MQTTでサーボモータをUI（ブラウザ）から制御&lt;/h2&gt;

&lt;p&gt;先ほどのプログラムはNode-RED上のボタンを押すとある角度回転するというものでした。次はそれを発展させて、&lt;strong&gt;ブラウザから操作して角度を遠隔で制御&lt;/strong&gt;してみます。&lt;/p&gt;

&lt;p&gt;ハンズオンでは、製作途中にタイムアップしてしまいました。少し難易度高めです。&lt;/p&gt;

&lt;h3 id=&#34;node-redのフローのコード-1&#34;&gt;Node-REDのフローのコード&lt;/h3&gt;

&lt;p&gt;下記のNode-REDのフローのコードをNode-REDにコピーして使いましょう。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[
    {
        &amp;quot;id&amp;quot;: &amp;quot;f2dc1b0b.520f98&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;mqtt out&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;fab71764.66ef78&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;topic&amp;quot;: &amp;quot;servo/pan&amp;quot;,
        &amp;quot;qos&amp;quot;: &amp;quot;1&amp;quot;,
        &amp;quot;retain&amp;quot;: &amp;quot;false&amp;quot;,
        &amp;quot;broker&amp;quot;: &amp;quot;954b988c.ec1e08&amp;quot;,
        &amp;quot;x&amp;quot;: 520,
        &amp;quot;y&amp;quot;: 400,
        &amp;quot;wires&amp;quot;: []
    },
    {
        &amp;quot;id&amp;quot;: &amp;quot;954b988c.ec1e08&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;mqtt-broker&amp;quot;,
        &amp;quot;z&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;name&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;broker&amp;quot;: &amp;quot;https://test.mosquitto.org/&amp;quot;,
        &amp;quot;port&amp;quot;: &amp;quot;1883&amp;quot;,
        &amp;quot;clientid&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;usetls&amp;quot;: false,
        &amp;quot;compatmode&amp;quot;: true,
        &amp;quot;keepalive&amp;quot;: &amp;quot;60&amp;quot;,
        &amp;quot;cleansession&amp;quot;: true,
        &amp;quot;birthTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;birthQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;birthPayload&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;closeTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;closePayload&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;willTopic&amp;quot;: &amp;quot;&amp;quot;,
        &amp;quot;willQos&amp;quot;: &amp;quot;0&amp;quot;,
        &amp;quot;willPayload&amp;quot;: &amp;quot;&amp;quot;
    }
]
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;nefry-btのプログラム-1&#34;&gt;Nefry BTのプログラム&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-c++&#34;&gt;
#include &amp;lt;Nefry.h&amp;gt;
#include &amp;lt;WiFiClient.h&amp;gt;
#include &amp;lt;PubSubClient.h&amp;gt;
#include &amp;lt;ArduinoJson.h&amp;gt;
//esp32でPWMを使えるようにするためのライブラリー//
#include&amp;quot;esp32-hal-ledc.h&amp;quot;
//////////////////////////////////////////////

//分解能//////////////////////////////////////
#define PWM_BITWIDTH 16
//////////////////////////////////////////////

//PWM制御：周波数-&amp;gt;角度に変換(プログラムするときにわかりやすい)//
int deg2pw(int deg, int bit){
    double ms = ((double) deg - 90.0) * 0.95 / 90.0 + 1.45;
    return (int) (ms / 20.0 * pow(2, bit));
}
////////////////////////////////////////////////////////////


IPAddress endpoint;
const int port = 1883;

const char *pubTopic;
const char *subTopic;
const char *deviceName;
const char *mqtt_server = &amp;quot;test.mosquitto.org&amp;quot;;

WiFiClient httpsClient;
PubSubClient mqttClient(httpsClient);



void setup() {
  ledcSetup(0,50,PWM_BITWIDTH);
  ledcAttachPin(A1,0);

  //// NefryBT設定 ////////////////////////////////////////

  // NefryBT
  pubTopic = &amp;quot;/pub/NefryBT/SAMPLE&amp;quot;;
  subTopic = &amp;quot;/sub/NefryBT/SAMPLE&amp;quot;;
  deviceName = &amp;quot;NefryBT_SAMPLE&amp;quot;;  // 複数台で利用する場合は必ずかぶらないように変更する
  // ローカルホストならパソコンのIPAddress型に収納。配列っぽく入れる。ここはその都度確認すること
  //mosquittoのテストサーバーを使うときは下記のednpointは気にしなくて大丈夫です
  endpoint[0] = 192;
  endpoint[1] = 168;
  endpoint[2] = 1;
  endpoint[3] = 1;

  ////////////////////////////////////////////

  Serial.begin(115200);

  mqttClient.setServer(mqtt_server, port);
  mqttClient.setCallback(mqttCallback);

  connectMQTT();
}

void connectMQTT() {
    Serial.println(&amp;quot;connectMQTT&amp;quot;);
    Serial.println(deviceName);
    while (!mqttClient.connected()) {
      Serial.print(&amp;quot;.&amp;quot;);
        if (mqttClient.connect(deviceName)) {
            Serial.println(&amp;quot;Connected.&amp;quot;);
            int qos = 0;
            mqttClient.subscribe(subTopic, qos);
            Serial.println(&amp;quot;Subscribed.&amp;quot;);
        } else {
            Serial.print(&amp;quot;Failed. Error state=&amp;quot;);
            Serial.print(mqttClient.state());
            // Wait 5 seconds before retrying
            delay(5000);
        }
    }
}

char pubMessage[128];

void mqttCallback (char* topic, byte* payload, unsigned int length) {

    String str = &amp;quot;&amp;quot;;
    Serial.print(&amp;quot;Received. topic=&amp;quot;);
    Serial.println(topic);
    for (int i = 0; i &amp;lt; length; i++) {
        Serial.print((char)payload[i]);
        str += (char)payload[i];
    }
    Serial.print(&amp;quot;\n&amp;quot;);

    StaticJsonBuffer&amp;lt;200&amp;gt; jsonBuffer;

    JsonObject&amp;amp; root = jsonBuffer.parseObject(str);

    // パースが成功かどうか判断
    if (!root.success()) {
      Serial.println(&amp;quot;parseObject() failed&amp;quot;);
      return;
    }

    const char* message = root[&amp;quot;message&amp;quot;];
    int takudooon = root[&amp;quot;takudooon&amp;quot;];

    Serial.print(&amp;quot;takudooon = &amp;quot;);
    Serial.println(takudooon);

    if( takudooon == 1 ){
       for(int i=90; i&amp;lt;=115; i++){
          ledcWrite(0,deg2pw(i, PWM_BITWIDTH));
       }
       delay(800);
       ledcWrite(0,deg2pw(90, PWM_BITWIDTH));
    } else {
       for(int i=90; i&amp;gt;=65; --i){//0～180°の位置で考える、90度が基準点としてそこからどう動くかを考える
          ledcWrite(0,deg2pw(i, PWM_BITWIDTH));
       }
       delay(800);
       ledcWrite(0,deg2pw(90, PWM_BITWIDTH));
    }

    Nefry.ndelay(1000);

}

void mqttLoop() {
    if (!mqttClient.connected()) {
        connectMQTT();
    }
    mqttClient.loop();
}

void loop() {
  mqttLoop();
 }

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;操作画面を用意&#34;&gt;操作画面を用意&lt;/h3&gt;

&lt;p&gt;それぞれのプログラムが準備できたら、Node-REDの画面から、




&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/187/6.png&#34; alt=&#34;6&#34;&gt;

&lt;/center&gt;
&lt;/p&gt;

&lt;p&gt;URLの「&lt;code&gt;http://localhost:1880&lt;/code&gt;」を「&lt;code&gt;http://localhost:1880/ui&lt;/code&gt;」と記述すると以下のような操作画面があらわれます。ここから、直感的にサーボモータの角度を遠隔制御できるようになります。&lt;/p&gt;





&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/187/7.png&#34; alt=&#34;7&#34;&gt;

&lt;/center&gt;


&lt;h3 id=&#34;実際に動かすと&#34;&gt;実際に動かすと……&lt;/h3&gt;

&lt;p&gt;このようになります。
&lt;img src=&#34;https://dotstud.io/img/blog/187/8.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;おわりに&#34;&gt;おわりに&lt;/h2&gt;

&lt;p&gt;いろいろな技術を知ることでモノづくりの幅が増え、作ってみたいものを自由に作れるようになってもらえればな、と思います。&lt;/p&gt;

&lt;p&gt;では！&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ClovaとNefryBT（ESP32）を連携させてみよう</title>
      <link>https://dotstud.io/blog/clova-ifttt-nefrybt-arduino/</link>
      <pubDate>Tue, 10 Jul 2018 10:00:00 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/clova-ifttt-nefrybt-arduino/</guid>
      
      <description>

&lt;p&gt;こんにちは、代表の&lt;a href=&#34;https://twitter.com/n0bisuke&#34;&gt;n0bisuke&lt;/a&gt;です。&lt;/p&gt;

&lt;p&gt;LINEのスマートスピーカーClova（正式にはAIアシスタントの名前）が&lt;a href=&#34;http://clova-blog.line.me/ja/archives/7990256.html&#34;&gt;IFTTTに対応&lt;/a&gt;したのでNefry BT（ESP32）と連携してみました。（実は結構前から対応してたんだけど試せてなかった）&lt;/p&gt;

&lt;p&gt;先日作った勤怠システムについては以下の記事をご参照ください。&lt;/p&gt;



&lt;section class=&#34;link&#34; id=&#34;183&#34;&gt;
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
          &lt;div class=&#34;link_content&#34;&gt;
          &lt;a href=&#34;https://dotstud.io/blog/keyboard-kintai-system-diy/&#34;&gt;&lt;/a&gt;
          &lt;img src=&#34;https://dotstud.io/img/blog/183/00_thumbnail.png&#34; alt=&#34;サムネイル&#34;&gt;
          &lt;/div&gt;
          &lt;div class=&#34;link_content&#34;&gt;
            &lt;div class=&#34;link_detail&#34;&gt;
              &lt;div class=&#34;link_title&#34;&gt;
                NefryBTとキーボードで作る簡易勤怠管理システム
              &lt;/div&gt;
              &lt;div class=&#34;link_date&#34;&gt;
                
                2018-07-05
              &lt;/div&gt;
              &lt;div class=&#34;link_desc&#34;&gt;
                今日はとある電子工作向けキーパッドを手に入れたのでNefry BTで使ってみて勤怠管理システムを作ってみた話です。
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/section&gt;
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
&lt;/section&gt;


&lt;p&gt;ちなみにこの勤怠システムは割と運用できてます。今の所は。&lt;/p&gt;

&lt;h2 id=&#34;clovaって&#34;&gt;Clovaって？&lt;/h2&gt;

&lt;p&gt;ClovaはLINEが開発したAIアシスタントです。Clova FriendsやClova Friends mini、Clova Waveなどの対応スマートスピーカー端末が販売されています。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;公式サイト: &lt;a href=&#34;https://clova.line.me/&#34;&gt;https://clova.line.me/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;GoogleのGoogle アシスタント（Google Home）やAmazonのAlexa（Amazon Echo）などと同じ並びの立ち位置という認識で大丈夫です。&lt;/p&gt;

&lt;p&gt;LINEといえばスタンプやキャラクターが特徴的ですが、Clova Friendsに関してもLINEが提供しているということもあり、 &lt;strong&gt;キャラクターをベースにしたデバイスが特徴的です&lt;/strong&gt;。&lt;/p&gt;





&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/185/1.png&#34; alt=&#34;1&#34;&gt;

  ─ ちなみにこの写真は先日のLINE CONFERENCE 2018で発表があったミニオンズモデル

&lt;/center&gt;


&lt;p&gt;この記事の執筆時点（2018年7月7日）ではまだ開発用SDKは公開されていませんが、IFTTTに対応したというリリースが出ているのでIFTTT経由で色々なサービスと接続することが出来ます。&lt;/p&gt;

&lt;h2 id=&#34;出勤するとclovaがしゃべる&#34;&gt;出勤するとClovaがしゃべる&lt;/h2&gt;

&lt;p&gt;今回作ったものはこんな感じです。&lt;/p&gt;

&lt;p&gt;試してるのはアルバイトの佐々木さんです。ドヤ顔は素です。&lt;/p&gt;

&lt;p&gt;&lt;center&gt;
&lt;blockquote class=&#34;instagram-media&#34; data-instgrm-captioned data-instgrm-permalink=&#34;https://www.instagram.com/p/Bk4KrVtl1qU/&#34; data-instgrm-version=&#34;8&#34; style=&#34; background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);&#34;&gt;&lt;div style=&#34;padding:8px;&#34;&gt; &lt;div style=&#34; background:#F8F8F8; line-height:0; margin-top:40px; padding:28.194444444444443% 0; text-align:center; width:100%;&#34;&gt; &lt;div style=&#34; background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;&#34;&gt;&lt;/div&gt;&lt;/div&gt; &lt;p style=&#34; margin:8px 0 0 0; padding:0 4px;&#34;&gt; &lt;a href=&#34;https://www.instagram.com/p/Bk4KrVtl1qU/&#34; style=&#34; color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;&#34; target=&#34;\_blank&#34;&gt;Nefryとclovaをつないでみた。 #nefry #clova&lt;/a&gt;&lt;/p&gt; &lt;p style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;&#34;&gt;&lt;a href=&#34;https://www.instagram.com/n0bisuke/&#34; style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px;&#34; target=&#34;\_blank&#34;&gt; n0bisuke&lt;/a&gt;さん(@n0bisuke)がシェアした投稿 - &lt;time style=&#34; font-family:Arial,sans-serif; font-size:14px; line-height:17px;&#34; datetime=&#34;2018-07-06T05:00:48+00:00&#34;&gt;2018年 7月月5日午後10時00分PDT&lt;/time&gt;&lt;/p&gt;&lt;/div&gt;&lt;/blockquote&gt; &lt;script async defer src=&#34;//www.instagram.com/embed.js&#34;&gt;&lt;/script&gt;
&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;先日作った勤怠システムと連携してキーパッドのボタンを押して出勤登録するとClovaに通知がいきます。&lt;/p&gt;

&lt;h2 id=&#34;nefry-btとclovaを連携してみよう&#34;&gt;Nefry BTとClovaを連携してみよう&lt;/h2&gt;

&lt;p&gt;IFTTTのWebhookを用いてNefry BTからPOSTリクエストを送り、Clova側に通知させます。&lt;/p&gt;

&lt;p&gt;イメージはこんな感じです。&lt;/p&gt;





&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/185/2.png&#34; alt=&#34;2&#34;&gt;

&lt;/center&gt;


&lt;h3 id=&#34;iftttでアプレットの登録&#34;&gt;IFTTTでアプレットの登録&lt;/h3&gt;

&lt;p&gt;アプレットとは連携させるサービスとサービスの組み合わせのことを指します。&lt;/p&gt;

&lt;p&gt;IFTTTのユーザー登録などを完了したら&lt;a href=&#34;https://ifttt.com/create&#34;&gt;アプレット作成&lt;/a&gt;のページから新規のアプレットを作成します。&lt;/p&gt;





&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/185/3.png&#34; alt=&#34;3&#34;&gt;

&lt;/center&gt;


&lt;p&gt;まず&lt;code&gt;this&lt;/code&gt;を押すとトリガーとなるサービスを選択します。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/185/4.gif&#34; alt=&#34;&#34; /&gt;
Webhookを選択しましょう。&lt;/p&gt;

&lt;p&gt;



&lt;center style=&#34;color: #585858; font-size: 95%; padding-bottom: 10px;&#34;&gt;
&lt;img src=&#34;https://dotstud.io/img/blog/185/5.png&#34; alt=&#34;5&#34;&gt;

&lt;/center&gt;

任意のEvent Nameを指定します。&lt;code&gt;clova_things&lt;/code&gt;としました。&lt;/p&gt;

&lt;p&gt;次に&lt;code&gt;that&lt;/code&gt;を押してアウトプットとなるサービスを選択します。
&lt;img src=&#34;https://dotstud.io/img/blog/185/6.gif&#34; alt=&#34;&#34; /&gt;
clovaを選択しましょう。&lt;/p&gt;

&lt;p&gt;メッセージ内容の箇所に&lt;code&gt;Value1&lt;/code&gt;を指定します。これはNefry BTから受け取る1つ目の値を指します。
&lt;img src=&#34;https://i.gyazo.com/d868fea0c1d1738593a1f82d26ffbde2.png&#34; alt=&#34;&#34; /&gt;
&lt;code&gt;Create action&lt;/code&gt;のボタンを押して次のページで&lt;code&gt;Finish&lt;/code&gt;で完了です。&lt;/p&gt;

&lt;h3 id=&#34;curlで試してみる&#34;&gt;curlで試してみる&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://ifttt.com/services/maker_webhooks/settings&#34;&gt;IFTTTのWebhooksの設定画面&lt;/a&gt;を見てAPI KEYを確認しましょう。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;https://maker.ifttt.com/use/xxxxxxxxx&lt;/code&gt;というURLが表示されていると思いますが、&lt;code&gt;xxxxxxxxx&lt;/code&gt;の箇所がAPI KEYになります。&lt;/p&gt;

&lt;p&gt;curlでは以下のように試せます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -X POST -H &amp;quot;Content-Type: application/json&amp;quot; -d &#39;{&amp;quot;value1&amp;quot;:&amp;quot;てすと&amp;quot;}&#39; https://maker.ifttt.com/trigger/clova_things/with/key/xxxxxxxxx
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;リクエストするURLはこのような形です。&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;https://maker.ifttt.com/trigger/{{Event Name}}/with/key/{{API KEY}}&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Event Nameは今回の場合は任意の名前として&lt;code&gt;clova_things&lt;/code&gt;としていて、API KEYは&lt;code&gt;xxxxxxxxx&lt;/code&gt;の部分です。&lt;/p&gt;

&lt;h3 id=&#34;nefry-bt側のコード&#34;&gt;Nefry BT側のコード&lt;/h3&gt;

&lt;p&gt;勤怠システムの記事のコードとほぼ同様です。&lt;/p&gt;



&lt;section class=&#34;link&#34; id=&#34;183&#34;&gt;
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
          &lt;div class=&#34;link_content&#34;&gt;
          &lt;a href=&#34;https://dotstud.io/blog/keyboard-kintai-system-diy/&#34;&gt;&lt;/a&gt;
          &lt;img src=&#34;https://dotstud.io/img/blog/183/00_thumbnail.png&#34; alt=&#34;サムネイル&#34;&gt;
          &lt;/div&gt;
          &lt;div class=&#34;link_content&#34;&gt;
            &lt;div class=&#34;link_detail&#34;&gt;
              &lt;div class=&#34;link_title&#34;&gt;
                NefryBTとキーボードで作る簡易勤怠管理システム
              &lt;/div&gt;
              &lt;div class=&#34;link_date&#34;&gt;
                
                2018-07-05
              &lt;/div&gt;
              &lt;div class=&#34;link_desc&#34;&gt;
                今日はとある電子工作向けキーパッドを手に入れたのでNefry BTで使ってみて勤怠管理システムを作ってみた話です。
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/section&gt;
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
      
      
  
&lt;/section&gt;


&lt;p&gt;適宜読み替えてください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;WiFiClientSecure.h&amp;gt;
WiFiClientSecure client;
const int HTTP_PORT = 443;

//途中省略
//・
//・
//・

void iftttClovaPost(String message){
  const char* HOST = &amp;quot;maker.ifttt.com&amp;quot;;

  String url = &amp;quot;/trigger/clova_things/with/key/xxxxxxxxx&amp;quot;;
  url += &amp;quot;?value1=&amp;quot;; //value1にデータを送る
  url += StrPerEncord(escapeParameter(message).c_str()); //勤怠システム記事参照

  Serial.print(&amp;quot;connecting to &amp;quot;);
  Serial.println(HOST);

  if (!client.connect(HOST, HTTP_PORT)) {
    Serial.println(&amp;quot;connection failed&amp;quot;);
    return;
  }

  client.println(&amp;quot;POST &amp;quot; + url + &amp;quot; HTTP/1.1&amp;quot;);
  client.println(&amp;quot;Content-Type: application/json&amp;quot;);
  client.println(&amp;quot;Content-Type: application/x-www-form-urlencoded&amp;quot;);
  client.println(&amp;quot;Host: &amp;quot; + String(HOST));
  client.println(&amp;quot;Connection: close&amp;quot;);
  client.println();

  unsigned long timeout = millis();
  while (client.available() == 0) {    
    if (millis() - timeout &amp;gt; 5000) {
        Serial.println(&amp;quot;&amp;gt;&amp;gt;&amp;gt; Client Timeout !&amp;quot;);
        client.stop();
        return;
    }
  }

  // Read all the lines of the reply from server and print them to Serial
  while(client.available()) {
      String line = client.readStringUntil(&#39;\r&#39;);
      Serial.print(line);
  }

  Serial.println();
  Serial.println(&amp;quot;closing connection&amp;quot;);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;全体コードは&lt;a href=&#34;https://gist.github.com/n0bisuke/d2fab404e5073e936339a6c3442c1e4c#file-kintai-ino-L94-L133&#34;&gt;こちら&lt;/a&gt;です。&lt;/p&gt;

&lt;h2 id=&#34;試し方と使う際の注意点&#34;&gt;試し方と使う際の注意点&lt;/h2&gt;

&lt;p&gt;さて完成したら試してみます。&lt;/p&gt;

&lt;p&gt;&lt;center&gt;
&lt;blockquote class=&#34;instagram-media&#34; data-instgrm-captioned data-instgrm-permalink=&#34;https://www.instagram.com/p/Bk4KrVtl1qU/&#34; data-instgrm-version=&#34;8&#34; style=&#34; background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);&#34;&gt;&lt;div style=&#34;padding:8px;&#34;&gt; &lt;div style=&#34; background:#F8F8F8; line-height:0; margin-top:40px; padding:28.194444444444443% 0; text-align:center; width:100%;&#34;&gt; &lt;div style=&#34; background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;&#34;&gt;&lt;/div&gt;&lt;/div&gt; &lt;p style=&#34; margin:8px 0 0 0; padding:0 4px;&#34;&gt; &lt;a href=&#34;https://www.instagram.com/p/Bk4KrVtl1qU/&#34; style=&#34; color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;&#34; target=\_blank&#34;&gt;Nefryとclovaをつないでみた。 #nefry #clova&lt;/a&gt;&lt;/p&gt; &lt;p style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;&#34;&gt;&lt;a href=&#34;https://www.instagram.com/n0bisuke/&#34; style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px;&#34; target=&#34;\_blank&#34;&gt; n0bisuke&lt;/a&gt;さん(@n0bisuke)がシェアした投稿 - &lt;time style=&#34; font-family:Arial,sans-serif; font-size:14px; line-height:17px;&#34; datetime=&#34;2018-07-06T05:00:48+00:00&#34;&gt;2018年 7月月5日午後10時00分PDT&lt;/time&gt;&lt;/p&gt;&lt;/div&gt;&lt;/blockquote&gt; &lt;script async defer src=&#34;//www.instagram.com/embed.js&#34;&gt;&lt;/script&gt;
&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;キーパッドを押すとClovaに通知がいき、&lt;strong&gt;「通知を読み上げて」&lt;/strong&gt;とClovaに話かけてあげると読み上げてくれます。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;はじめはWebhooksで通知するとそのままClovaが喋ってくれると思ったのですがそうではないので注意です。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;center&gt;
&lt;blockquote class=&#34;twitter-tweet&#34; data-lang=&#34;ja&#34;&gt;&lt;p lang=&#34;ja&#34; dir=&#34;ltr&#34;&gt;clovaのifttt試してみてるけどぜんぜん喋ってくれない… なんだろう&lt;/p&gt; のびすけ / sugawara (@n0bisuke) &lt;a href=&#34;https://twitter.com/n0bisuke/status/1015057186026737664?ref_src=twsrc%5Etfw&#34;&gt;2018年7月6日&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async src=&#34;https://platform.twitter.com/widgets.js&#34; charset=&#34;utf-8&#34;&gt;&lt;/script&gt;
&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;通知が来た時点で何も喋ってくれないのは分かりにくいですね。現時点だと「通知を読み上げて」と言わないと読み上げてくれないので注意ですね。&lt;/p&gt;

&lt;h2 id=&#34;まとめ&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;Nefry BTをClovaを繋げることが出来ました。&lt;/p&gt;

&lt;p&gt;IFTTTに繋がると実質何とでも繋げられるので嬉しいですね。&lt;/p&gt;

&lt;p&gt;人間が「通知を読み上げて」と言わなくても喋ってくれるように機能追加してくれることに期待です。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>NefryBTとキーボードで作る簡易勤怠管理システム</title>
      <link>https://dotstud.io/blog/keyboard-kintai-system-diy/</link>
      <pubDate>Thu, 05 Jul 2018 10:00:00 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/keyboard-kintai-system-diy/</guid>
      
      <description>

&lt;p&gt;こんにちは、代表の&lt;a href=&#34;https://dotstud.io/members/n0bisuke&#34;&gt;n0bisuke&lt;/a&gt;です。&lt;/p&gt;

&lt;p&gt;今日はとある電子工作向けキーパッドを手に入れたので、&lt;strong&gt;Nefry BTで簡易的な勤怠管理システム&lt;/strong&gt;を作ってみました。ちなみにオチとかないです。&lt;/p&gt;

&lt;h2 id=&#34;使うもの&#34;&gt;使うもの&lt;/h2&gt;

&lt;h3 id=&#34;マトリックスフィルムボタンキーボード-メンブレン式キーボード-4-4&#34;&gt;マトリックスフィルムボタンキーボード メンブレン式キーボード 4*4&lt;/h3&gt;

&lt;p&gt;HiLetgoというストアから出品されています。眺めていて使ってみたいなぁという欲求が湧いたのでポチりました。&lt;/p&gt;

&lt;p&gt;ちなみに5個セットなので、あと4個なにか作れます。&lt;/p&gt;

&lt;p&gt;&lt;center&gt;
&lt;iframe style=&#34;width:120px;height:240px;&#34; marginwidth=&#34;0&#34; marginheight=&#34;0&#34; scrolling=&#34;no&#34; frameborder=&#34;0&#34; src=&#34;//rcm-fe.amazon-adsystem.com/e/cm?lt1=\å_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=n0bisuke-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=as_ss_li_til&amp;asins=B010Q17I8E&amp;linkId=9116436de3640fbe22f359a3eb280f43&#34;&gt;&lt;/iframe&gt;
&lt;/center&gt;&lt;/p&gt;

&lt;h2 id=&#34;arduino-unoで動かしてみる&#34;&gt;Arduino Unoで動かしてみる&lt;/h2&gt;

&lt;p&gt;AmazonのページにはArduino対応と書いているのでどうやら使えるらしい。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://techtutorialsx.com/2017/03/18/esp8266-interfacing-with-a-4x4-matrix-keypad/&#34;&gt;ESP8266: Interfacing with a 4×4 Matrix Keypad
&lt;/a&gt;という記事があったので参考にArduinoで動かしてみました。&lt;/p&gt;

&lt;h3 id=&#34;配線&#34;&gt;配線&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/3c3b4883c69f25b562906e38f853beb4.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Arduino Unoとあとで紹介するNefry BTでの配線はこんな感じです。&lt;/p&gt;

&lt;h3 id=&#34;プログラム&#34;&gt;プログラム&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;Chris--A/Keypad&#34;&gt;こちらのライブラリ&lt;/a&gt;をインストールしましょう。&lt;/p&gt;

&lt;p&gt;ライブラリマネージャからもインストールできます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/d1d90cb4712729faac8272bcf3274767.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;Keypad.h&amp;gt;

const byte n_rows = 4;
const byte n_cols = 4;

char keys[n_rows][n_cols] = {
  {&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;A&#39;},
  {&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;B&#39;},
  {&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;C&#39;},
  {&#39;*&#39;,&#39;0&#39;,&#39;#&#39;,&#39;D&#39;}
};

byte colPins[n_rows] = {3, 2, 1, 0};
byte rowPins[n_cols] = {7, 6, 5, 4};

Keypad myKeypad = Keypad( makeKeymap(keys), rowPins, colPins, n_rows, n_cols);

void setup(){
  Serial.begin(115200);
}

void loop(){
  char myKey = myKeypad.getKey();

  if (myKey != NULL){
    Serial.print(&amp;quot;Key pressed: &amp;quot;);
    Serial.println(myKey);
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;実行&#34;&gt;実行&lt;/h3&gt;

&lt;p&gt;&lt;blockquote class=&#34;instagram-media&#34; data-instgrm-captioned data-instgrm-permalink=&#34;https://www.instagram.com/p/BkzAcUMB-3K/&#34; data-instgrm-version=&#34;8&#34; style=&#34; background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);&#34;&gt;&lt;div style=&#34;padding:8px;&#34;&gt; &lt;div style=&#34; background:#F8F8F8; line-height:0; margin-top:40px; padding:28.194444444444443% 0; text-align:center; width:100%;&#34;&gt; &lt;div style=&#34; background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;&#34;&gt;&lt;/div&gt;&lt;/div&gt; &lt;p style=&#34; margin:8px 0 0 0; padding:0 4px;&#34;&gt; &lt;a href=&#34;https://www.instagram.com/p/BkzAcUMB-3K/&#34; style=&#34; color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;&#34; target=&#34;_blank&#34;&gt;電子工作用のキーボード使ってみたけどハマることなく試せた 勤怠記録とかオフィスハックの何かに使いたい #dotstudio&lt;/a&gt;&lt;/p&gt; &lt;p style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;&#34;&gt;&lt;a href=&#34;https://www.instagram.com/n0bisuke/&#34; style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px;&#34; target=&#34;_blank&#34;&gt; n0bisuke&lt;/a&gt;さん(@n0bisuke)がシェアした投稿 - &lt;time style=&#34; font-family:Arial,sans-serif; font-size:14px; line-height:17px;&#34; datetime=&#34;2018-07-04T04:53:24+00:00&#34;&gt;2018年 7月月3日午後9時53分PDT&lt;/time&gt;&lt;/p&gt;&lt;/div&gt;&lt;/blockquote&gt; &lt;script async defer src=&#34;//www.instagram.com/embed.js&#34;&gt;&lt;/script&gt;&lt;/p&gt;

&lt;h2 id=&#34;nefry-btで動作させて勤怠システムに&#34;&gt;Nefry BTで動作させて勤怠システムに&lt;/h2&gt;

&lt;p&gt;出退勤の記録を付ける電子工作は、&lt;strong&gt;今まで何度か作りはしたものの導入まで至っていなかった&lt;/strong&gt;です。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;作り込もうとして力を入れすぎて力尽きる問題&lt;/strong&gt;が大きいと思っています。&lt;/p&gt;

&lt;p&gt;ということで&lt;u&gt;実装がシンプルな勤怠システムをとりあえず導入&lt;/u&gt;してみました。&lt;/p&gt;

&lt;h3 id=&#34;ボタン入力式&#34;&gt;ボタン入力式&lt;/h3&gt;

&lt;p&gt;仕様は&lt;strong&gt;数字を押して選択し、Aボタンで出勤記録、Bボタンで退勤記録&lt;/strong&gt;です。&lt;/p&gt;

&lt;p&gt;ディスプレイには登録している名前が出ます。&lt;/p&gt;

&lt;p&gt;多分そのうちSuica連携とかBLEデバイス連携とか指紋とか声門とかそういうのも試してみる気はするのですが、 &lt;strong&gt;ボタン入力とHTTP通信だけの実装のシンプルさ&lt;/strong&gt;がとりあえず始めるには重要な気がしました。&lt;/p&gt;

&lt;p&gt;制作時間1時間程度。HTTP POST周りで少し手こずってました。&lt;/p&gt;

&lt;p&gt;&lt;blockquote class=&#34;instagram-media&#34; data-instgrm-captioned data-instgrm-permalink=&#34;https://www.instagram.com/p/Bkz8a0ihnYF/&#34; data-instgrm-version=&#34;8&#34; style=&#34; background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);&#34;&gt;&lt;div style=&#34;padding:8px;&#34;&gt; &lt;div style=&#34; background:#F8F8F8; line-height:0; margin-top:40px; padding:28.194444444444443% 0; text-align:center; width:100%;&#34;&gt; &lt;div style=&#34; background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;&#34;&gt;&lt;/div&gt;&lt;/div&gt; &lt;p style=&#34; margin:8px 0 0 0; padding:0 4px;&#34;&gt; &lt;a href=&#34;https://www.instagram.com/p/Bkz8a0ihnYF/&#34; style=&#34; color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;&#34; target=&#34;_blank&#34;&gt;Nefryとつないでみた。キーの押し心地がよい&lt;/a&gt;&lt;/p&gt; &lt;p style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;&#34;&gt;&lt;a href=&#34;https://www.instagram.com/n0bisuke/&#34; style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px;&#34; target=&#34;_blank&#34;&gt; n0bisuke&lt;/a&gt;さん(@n0bisuke)がシェアした投稿 - &lt;time style=&#34; font-family:Arial,sans-serif; font-size:14px; line-height:17px;&#34; datetime=&#34;2018-07-04T13:35:59+00:00&#34;&gt;2018年 7月月4日午前6時35分PDT&lt;/time&gt;&lt;/p&gt;&lt;/div&gt;&lt;/blockquote&gt; &lt;script async defer src=&#34;//www.instagram.com/embed.js&#34;&gt;&lt;/script&gt;&lt;/p&gt;

&lt;h3 id=&#34;実装&#34;&gt;実装&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://dotstud.io/docs/nefrybt-http-post/&#34;&gt;Nefry BTでのHTTP POST&lt;/a&gt;も合わせて読むとコード理解が進みます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;Keypad.h&amp;gt;
#include &amp;lt;NefryDisplay.h&amp;gt;
#include &amp;lt;WiFiClientSecure.h&amp;gt;
WiFiClientSecure client;

String StrPerEncord(const char* c_str);
String escapeParameter(String param);
void hipchatPost(String message);

const int HTTP_PORT = 443;
const char* HOST = &amp;quot;xxxxxxxxxx.hipchat.com&amp;quot;;

const byte n_rows = 4;
const byte n_cols = 4;

char keys[n_rows][n_cols] = {
  {&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;A&#39;},
  {&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;B&#39;},
  {&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;C&#39;},
  {&#39;*&#39;,&#39;0&#39;,&#39;#&#39;,&#39;D&#39;}
};

byte colPins[n_rows] = {D3, D2, D1, D0};
byte rowPins[n_cols] = {D7, D6, D5, D4};
Keypad myKeypad = Keypad( makeKeymap(keys), rowPins, colPins, n_rows, n_cols);

String storeMessage = &amp;quot;&amp;quot;;

//3行目だけにPrint
void nfDisplay3Print(String mes){
  NefryDisplay.print(&amp;quot;&amp;quot;);
  NefryDisplay.print(&amp;quot;&amp;quot;);
  NefryDisplay.print(mes);
}

void setup() {
  Serial.begin(115200);
  NefryDisplay.setTitle(&amp;quot;KINTAI&amp;quot;);
  nfDisplay3Print(&amp;quot;Please Input...&amp;quot;);
}

void loop() {
  char myKey = myKeypad.getKey();
  String member = &amp;quot;&amp;quot;;

  //ボタンが押された時の処理
  if (myKey != NULL){
    Serial.print(&amp;quot;Key pressed: &amp;quot;);
    Serial.println(myKey);

    if(String(myKey) == &amp;quot;1&amp;quot;){
      member += &amp;quot;n0bisuke&amp;quot;;
      storeMessage = member;
    }else if(String(myKey) == &amp;quot;2&amp;quot;){
      member += &amp;quot;chantoku&amp;quot;;
      storeMessage = member;
    }else if(String(myKey) == &amp;quot;3&amp;quot;){
      member += &amp;quot;kiki&amp;quot;;
      storeMessage = member;
    }else if(String(myKey) == &amp;quot;4&amp;quot;){
      member += &amp;quot;takudon&amp;quot;;
      storeMessage = member;
    }else if(String(myKey) == &amp;quot;5&amp;quot;){
      member += &amp;quot;sasakitomohiro&amp;quot;;
      storeMessage = member;
    }

    nfDisplay3Print(String(myKey) + &amp;quot;:&amp;quot; + member);

    if(String(myKey) == &amp;quot;A&amp;quot;){
      nfDisplay3Print(String(myKey) + &amp;quot;: [Office IN] post to HipChat...&amp;quot;);

      storeMessage += &amp;quot;さんが出勤しました。&amp;quot;;
      hipchatPost(storeMessage); //HipChatに投稿
      storeMessage = &amp;quot;&amp;quot;; //リセット

      nfDisplay3Print(String(myKey) + &amp;quot;: POST DONE&amp;quot;);
    }else if(String(myKey) == &amp;quot;B&amp;quot;){
      nfDisplay3Print(String(myKey) + &amp;quot;: [Office OUT] post to HipChat...&amp;quot;);

      storeMessage += &amp;quot;さんが退勤しました。&amp;quot;;
      hipchatPost(storeMessage); //HipChatに投稿
      storeMessage = &amp;quot;&amp;quot;; //リセット

      nfDisplay3Print(String(myKey) + &amp;quot;: POST DONE&amp;quot;);
    }  
  }
}

void hipchatPost(String message){
  String url = &amp;quot;/v2/room/4651875/notification?auth_token=xxxxxxxxxxxxxxxx&amp;quot;;
  url += &amp;quot;&amp;amp;color=green&amp;amp;notify=false&amp;amp;message_format=text&amp;amp;message=&amp;quot;;
  url += StrPerEncord(escapeParameter(message + &amp;quot; (yey)&amp;quot;).c_str());

  Serial.print(&amp;quot;connecting to &amp;quot;);
  Serial.println(HOST);

  if (!client.connect(HOST, HTTP_PORT)) {
    Serial.println(&amp;quot;connection failed&amp;quot;);
    return;
  }

  client.println(&amp;quot;POST &amp;quot; + url + &amp;quot; HTTP/1.1&amp;quot;);
  client.println(&amp;quot;Content-Type: application/json&amp;quot;);
  client.println(&amp;quot;Content-Type: application/x-www-form-urlencoded&amp;quot;);
  client.println(&amp;quot;Host: &amp;quot; + String(HOST));
  client.println(&amp;quot;Connection: close&amp;quot;);
  client.println();

  unsigned long timeout = millis();
  while (client.available() == 0) {    
    if (millis() - timeout &amp;gt; 5000) {
        Serial.println(&amp;quot;&amp;gt;&amp;gt;&amp;gt; Client Timeout !&amp;quot;);
        client.stop();
        return;
    }
  }

  // Read all the lines of the reply from server and print them to Serial
  while(client.available()) {
      String line = client.readStringUntil(&#39;\r&#39;);
      Serial.print(line);
  }

  Serial.println();
  Serial.println(&amp;quot;closing connection&amp;quot;);
}

String StrPerEncord(const char* c_str) {
  uint16_t i = 0;
  String str_ret = &amp;quot;&amp;quot;;
  char c1[3], c2[3], c3[3];

  while (c_str[i] != &#39;\0&#39;) {
    if (c_str[i] &amp;gt;= 0xC2 &amp;amp;&amp;amp; c_str[i] &amp;lt;= 0xD1) { //2バイト文字
      sprintf(c1, &amp;quot;%2x&amp;quot;, c_str[i]);
      sprintf(c2, &amp;quot;%2x&amp;quot;, c_str[i + 1]);
      str_ret += &amp;quot;%&amp;quot; + String(c1) + &amp;quot;%&amp;quot; + String(c2);
      i = i + 2;
    } else if (c_str[i] &amp;gt;= 0xE2 &amp;amp;&amp;amp; c_str[i] &amp;lt;= 0xEF) {
      sprintf(c1, &amp;quot;%2x&amp;quot;, c_str[i]);
      sprintf(c2, &amp;quot;%2x&amp;quot;, c_str[i + 1]);
      sprintf(c3, &amp;quot;%2x&amp;quot;, c_str[i + 2]);
      str_ret += &amp;quot;%&amp;quot; + String(c1) + &amp;quot;%&amp;quot; + String(c2) + &amp;quot;%&amp;quot; + String(c3);
      i = i + 3;
    } else {
      str_ret += String(c_str[i]);
      i++;
    }
  }
  return str_ret;
}

String escapeParameter(String param) {
  param.replace(&amp;quot;%&amp;quot;, &amp;quot;%25&amp;quot;);
  param.replace(&amp;quot;+&amp;quot;, &amp;quot;%2B&amp;quot;);
  param.replace(&amp;quot; &amp;quot;, &amp;quot;+&amp;quot;);
  param.replace(&amp;quot;\&amp;quot;&amp;quot;, &amp;quot;%22&amp;quot;);
  param.replace(&amp;quot;#&amp;quot;, &amp;quot;%23&amp;quot;);
  param.replace(&amp;quot;$&amp;quot;, &amp;quot;%24&amp;quot;);
  param.replace(&amp;quot;&amp;amp;&amp;quot;, &amp;quot;%26&amp;quot;);
  param.replace(&amp;quot;&#39;&amp;quot;, &amp;quot;%27&amp;quot;);
  param.replace(&amp;quot;(&amp;quot;, &amp;quot;%28&amp;quot;);
  param.replace(&amp;quot;)&amp;quot;, &amp;quot;%29&amp;quot;);
  param.replace(&amp;quot;*&amp;quot;, &amp;quot;%2A&amp;quot;);
  param.replace(&amp;quot;,&amp;quot;, &amp;quot;%2C&amp;quot;);
  param.replace(&amp;quot;/&amp;quot;, &amp;quot;%2F&amp;quot;);
  param.replace(&amp;quot;:&amp;quot;, &amp;quot;%3A&amp;quot;);
  param.replace(&amp;quot;;&amp;quot;, &amp;quot;%3B&amp;quot;);
  param.replace(&amp;quot;&amp;lt;&amp;quot;, &amp;quot;%3C&amp;quot;);
  param.replace(&amp;quot;=&amp;quot;, &amp;quot;%3D&amp;quot;);
  param.replace(&amp;quot;&amp;gt;&amp;quot;, &amp;quot;%3E&amp;quot;);
  param.replace(&amp;quot;?&amp;quot;, &amp;quot;%3F&amp;quot;);
  param.replace(&amp;quot;@&amp;quot;, &amp;quot;%40&amp;quot;);
  param.replace(&amp;quot;[&amp;quot;, &amp;quot;%5B&amp;quot;);
  param.replace(&amp;quot;\\&amp;quot;, &amp;quot;%5C&amp;quot;);
  param.replace(&amp;quot;]&amp;quot;, &amp;quot;%5D&amp;quot;);
  param.replace(&amp;quot;^&amp;quot;, &amp;quot;%5E&amp;quot;);
  param.replace(&amp;quot;&#39;&amp;quot;, &amp;quot;%60&amp;quot;);
  param.replace(&amp;quot;{&amp;quot;, &amp;quot;%7B&amp;quot;);
  param.replace(&amp;quot;|&amp;quot;, &amp;quot;%7C&amp;quot;);
  param.replace(&amp;quot;}&amp;quot;, &amp;quot;%7D&amp;quot;);
  return param;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;まとめ&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;運用1日目ですが問題ないです（謎）&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;実際にはシートに記録したりした方が良いと思いますが今後検討です！&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/fcc920005a4a691f37081c936f6968d1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;HipChatの部分はうちの社内がHipChatだからというだけですが、LINEだったりSlackだったりも同様のやり方で連携できます。&lt;/p&gt;

&lt;p&gt;思ったより簡単に試せたなぁという印象なのでみなさんもぜひ試してみてください。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>自動水やり装置を作ろう！Nefry BTとGroveモジュールでズボラのための電子工作</title>
      <link>https://dotstud.io/blog/nefrybt-motor-watering-system/</link>
      <pubDate>Tue, 03 Apr 2018 10:00:26 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/nefrybt-motor-watering-system/</guid>
      
      <description>

&lt;p&gt;こんにちは、ちゃんとくです！日中は温かくなって、すっかり春めいてきました。&lt;/p&gt;

&lt;p&gt;春といえば花。&lt;/p&gt;

&lt;p&gt;花といえばそう、&lt;strong&gt;自動水やり装置ですね&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;この季節にぴったりの装置を、お手軽開発ボード&lt;a href=&#34;https://dotstud.io/docs/nefrybt&#34;&gt;Nefry BT&lt;/a&gt;を使って自作してみましょう！&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/148/watering.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;まずは簡単に、&lt;u&gt;土が乾いたら水をやる機構&lt;/u&gt;を作っていきましょう。&lt;/p&gt;

&lt;p&gt;なお今回のレシピはNefry BT開発者の&lt;a href=&#34;https://dotstud.io/members/wami&#34;&gt;わみ&lt;/a&gt;さんにご提供いただきました！&lt;/p&gt;

&lt;h2 id=&#34;開発の前に&#34;&gt;開発の前に&lt;/h2&gt;

&lt;h3 id=&#34;環境構築&#34;&gt;環境構築&lt;/h3&gt;

&lt;p&gt;初めてNefry BTを使う方は、ドキュメントを参考に&lt;u&gt;Nefry BTのWi-Fi&lt;/u&gt;と&lt;u&gt;Arduino IDEのセットアップ&lt;/u&gt;を済ませておきましょう。&lt;/p&gt;

&lt;p&gt;⇒ 参考: &lt;a href=&#34;https://dotstud.io/docs/nefrybt-wifi-setup/&#34;&gt;Nefry BTのWi-Fiセットアップ&lt;/a&gt;&lt;br /&gt;
⇒ 参考: &lt;a href=&#34;https://dotstud.io/docs/nefrybt-arduino-ide-setup/&#34;&gt;Nefry BT向けのArduino IDEセットアップ方法&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;使うもの&#34;&gt;使うもの&lt;/h3&gt;

&lt;p&gt;いろいろな実装方法がありますが、今回は簡単に電気をON/OFFできる「&lt;strong&gt;リレー&lt;/strong&gt;（継電器）」というモジュールを使います。
&lt;img src=&#34;https://dotstud.io/img/blog/148/parts.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;水をやりたい植物&lt;/li&gt;
&lt;li&gt;Nefry BT + 専用ディスプレイ（ディスプレイはなくてもOK）&lt;/li&gt;
&lt;li&gt;Grove 水分センサ（&lt;a href=&#34;https://www.seeedstudio.com/grove-moisture-sensor-p-955.html&#34;&gt;SEEED-101020008&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;Grove リレーモジュール（&lt;a href=&#34;http://www.seeedstudio.com/depot/grove-relay-p-769.html&#34;&gt;SEEED-103020005&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;DCウォーターポンプ（&lt;a href=&#34;https://amzn.to/2IoPJI7&#34;&gt;こういうの&lt;/a&gt;。型番忘れてしまいましたが千石さんで購入。）&lt;/li&gt;
&lt;li&gt;ポンプ用シリコンチューブ（&lt;a href=&#34;https://amzn.to/2q29vBE&#34;&gt;こういうの&lt;/a&gt;。熱帯魚屋さんなどに売ってます。）&lt;/li&gt;
&lt;li&gt;ジャンパワイヤ（オス-オス） 1本&lt;/li&gt;
&lt;li&gt;水を貯めておく容器（コップなど）&lt;/li&gt;
&lt;li&gt;はんだごて + はんだ&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;配線&#34;&gt;配線&lt;/h2&gt;

&lt;p&gt;さっそく配線をしていきます！全体はこんな感じ。
&lt;img src=&#34;https://dotstud.io/img/blog/148/circuits.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/148/handa.png&#34; alt=&#34;&#34; /&gt;
ポンプへの給電はNefry BTからされるように、ポンプの線をリレーモジュールのGND部分にはんだづけします。モーターの回転方向は関係ないので今回はどちらの線でも大丈夫です。（一般的には赤がプラス、白または黒がマイナスです。）&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/148/relay.png&#34; alt=&#34;&#34; /&gt;
リレーにはこのように、ジャンパワイヤを挟んで止めることができます。小さいマイナスドライバなどで上部のネジを緩めて挟み、抜けないよう締めます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/148/kairo.png&#34; alt=&#34;&#34; /&gt;
ジャンパワイヤとポンプの線をそれぞれ挟みます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/148/nipper.png&#34; alt=&#34;&#34; /&gt;
挟む部分が足りない場合は、ニッパーやワイヤストリッパーでちょんちょんと切れ目を入れ被覆を剥きましょう。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/148/grove.png&#34; alt=&#34;&#34; /&gt;
Groveコネクタを使ってリレーモジュールはD2に、水分センサはA2（Nefry BT R2の場合はA1）に繋ぎます。（Nefry BT R2はA1の表記がA0になっているミスがあります。注意してください。）&lt;/p&gt;

&lt;p&gt;ジャンパはGPIOの5Vに刺します。&lt;/p&gt;

&lt;h2 id=&#34;プログラム&#34;&gt;プログラム&lt;/h2&gt;

&lt;p&gt;Arduino IDEに下記のプログラムを貼り付け、書き込みます。Nefry BT R2の場合はINの指定をA1にしてください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;Nefry.h&amp;gt;
#include &amp;lt;NefryDisplay.h&amp;gt;

#define IN A2 // 土壌センサ（R2の場合はA1）
#define OUT D2 // リレー-&amp;gt;モータ
#define AVE 5 // センサ値を平均化するための取得回数

int readRaw;
int aveRate;
int waterTimer;

void setup() {
  pinMode(OUT, OUTPUT);
  digitalWrite(OUT, LOW);
  delay(10000);
  NefryDisplay.print(&amp;quot;wait...&amp;quot;);
}

void loop() {
  readRaw = 0;
  for(int i=0;i&amp;lt;AVE;i++){
    readRaw = analogRead(IN);
    delay(500);
  }
  aveRate = readRaw/AVE;
  NefryDisplay.print((String)&amp;quot;readAve : &amp;quot;+aveRate/10/4+&amp;quot; %&amp;quot;);
  NefryDisplay.print((String)&amp;quot;aveRate : &amp;quot;+aveRate);
  if(aveRate&amp;lt;250){
    digitalWrite(OUT,HIGH);
    NefryDisplay.print(&amp;quot;Motor ON&amp;quot;);
    delay(3000);
    digitalWrite(OUT,LOW);
  }else{
    digitalWrite(OUT,LOW);
    NefryDisplay.print(&amp;quot;Motor OFF&amp;quot;);
  }
  delay(60000);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;動かしてみよう&#34;&gt;動かしてみよう&lt;/h2&gt;

&lt;p&gt;さっそく試してみます！デモ用に下記の動きになっています。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;乾いていない時（水分センサが水に浸っている時）= ポンプから水は出ない&lt;/li&gt;
&lt;li&gt;乾いている時（水分センサが水から出た時）= ポンプから水が出る&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;https://gyazo.com/34eb79467ebdd096591ecc893f1e5a5a.gif&#34; alt=&#34;&#34; /&gt;
ポンプが動きました！少し見づらいですが、ディスプレイの表示もOFF-&amp;gt;ONと切り替わっています。&lt;/p&gt;

&lt;h2 id=&#34;まとめ&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;ポンプを使った電子工作は一見難しいですが、Groveのリレーモジュールを使ってわりと簡単に作ることができました！&lt;/p&gt;

&lt;p&gt;ただこのままでは&lt;u&gt;給水用の水がなくなっても気づかなかったり、コップの水をこぼしそうになったり&lt;/u&gt;、少し使いづらいですよね……。&lt;/p&gt;

&lt;p&gt;次回は外装制作とWeb通知の連携をして&lt;strong&gt;より放置しやすい自動水やり装置にブラッシュアップ&lt;/strong&gt;してみます！&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>JavaScriptで開発できる！Mongoose OSでNefry BTをLチカしよう</title>
      <link>https://dotstud.io/blog/mongoose-os-nefry-blink/</link>
      <pubDate>Thu, 08 Feb 2018 00:00:00 +0000</pubDate>
      
      <guid>https://dotstud.io/blog/mongoose-os-nefry-blink/</guid>
      
      <description>

&lt;p&gt;唐突ですが、森田(&lt;a href=&#34;https://twitter.com/morita_pac&#34;&gt;@morita_pac&lt;/a&gt;)と申します。&lt;/p&gt;

&lt;p&gt;ヘビーNefryBTユーザです。持ち歩いていろんな場所でNefry BTを利用したり、ケースを作ったりもしています。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/145/1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;通常Nefry BTはArduino言語でプログラムするのですが、今回はJavaScriptで書き込めるようにしたいと思います。&lt;/p&gt;

&lt;p&gt;※この記事内のプログラムはNefy BT（無印）向けです。Nefry BT R2向けのプログラムは別途準備中です。&lt;/p&gt;

&lt;h2 id=&#34;javascriptで開発できるmongoose-osとは&#34;&gt;JavaScriptで開発できるMongoose OSとは&lt;/h2&gt;

&lt;p&gt;今回は&lt;a href=&#34;https://mongoose-os.com/&#34;&gt;Mongoose OS&lt;/a&gt;というIoTのプロト開発を簡単にできるサービスを利用します。&lt;/p&gt;

&lt;p&gt;&lt;center&gt;
&lt;a href=&#34;https://mongoose-os.com/&#34;&gt;&lt;img src=&#34;https://dotstud.io/img/blog/145/2.png&#34; alt=&#34;&#34; /&gt;&lt;/a&gt;
▲ Mongoose OS公式サイト
&lt;/center&gt;&lt;/p&gt;

&lt;p&gt;Mongoose OSでは、ESP32やESP8266へJavaScript（&lt;a href=&#34;https://github.com/cesanta/mjs&#34;&gt;mJS&lt;/a&gt;）でコードを書き込めます。
さらには、セキュアで、AWS IoTやGoogleのCloud IoT Coreなどとも連携設定がシンプルにできます。&lt;/p&gt;

&lt;p&gt;Mongoose OSをインストールしている間は元のNefry BTのプログラムは利用できなくなります。（Arduino IDEで書き込むことですぐに戻せます。）&lt;/p&gt;

&lt;h2 id=&#34;mongoose-osの開発環境をセットアップ&#34;&gt;Mongoose OSの開発環境をセットアップ&lt;/h2&gt;

&lt;h3 id=&#34;windowsの場合&#34;&gt;Windowsの場合&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://mongoose-os.com/software.html&#34;&gt;Download Page&lt;/a&gt;から、exeをダウンロードするだけで使えます。（アンチウイルス系のソフトが反応するかもしれません。）なお、以降MacOSでの説明になります。
&lt;img src=&#34;https://dotstud.io/img/blog/145/3.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;mac-osの場合&#34;&gt;Mac OSの場合&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://mongoose-os.com/software.html&#34;&gt;Download Page&lt;/a&gt;の、MacOS/Linuxのcurlコマンドをターミナルで実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -fsSL https://mongoose-os.com/downloads/mos/install.sh | /bin/bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/145/4.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ターミナルで以下のようになれば無事完了です。開く場合は、Runの&lt;code&gt;/xxx/.mos/bin/mos&lt;/code&gt;を実行するとWeb UIが開きます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -fsSL https://mongoose-os.com/downloads/mos/install.sh | /bin/bash
Downloading https://mongoose-os.com/downloads/mos-release/mac/mos ...
########################################################################
 100.0%
Installing into /xxx/.mos/bin/mos ...
Adding /xxx/.mos/bin to your PATH in /xxx/.profile
SUCCESS: /xxx/.mos/bin/mos is installed.
Run &#39;/xxx/.mos/bin/mos --help&#39; to see all available commands.
Run &#39;/xxx/.mos/bin/mos&#39; without arguments to start a simplified Web UI installer.
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;いざ-mongoose-osをnefry-btに入れてみよう&#34;&gt;いざ、Mongoose  OSをNefry BTに入れてみよう&lt;/h2&gt;

&lt;p&gt;Nefry BTをUSBポートに差し込み、Mongose OSとサンプルコードをFlashします。（次回起動時は、ポート選択のみで利用可能です。）&lt;/p&gt;

&lt;p&gt;Mongoose OSのWeb UIは、ブラウザで開きます。①②③の設定が完了すれば無事、JavaScriptで書き込む準備完了です。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/145/5.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;①は、Nefry BTのポートを選択します。ポートが見つからない場合はUSBを認識させるための&lt;a href=&#34;https://www.silabs.com/products/development-tools/software/usb-to-uart-bridge-vcp-drivers&#34;&gt;ドライバ&lt;/a&gt;をインストールする必要があります。
②では、Platformで「esp32」とapp「demo-js」を選択し「Flash」ボタンをクリックし、処理が終わるまで待ちます。
③では、Wi-fi設定を行います。（今回は必須ではないです。）
全ての設定が完了したら、「Done」ボタンをおしてdevice setupを閉じます。&lt;/p&gt;

&lt;h1 id=&#34;4-基本的なweb-uiとサンプルプログラム&#34;&gt;4. 基本的なWeb UIとサンプルプログラム&lt;/h1&gt;

&lt;h3 id=&#34;web-uiについて&#34;&gt;Web UIについて&lt;/h3&gt;

&lt;p&gt;まず、画面左側Device Filesを選択します。すると、init.jsが選択され、メインプログラムが表示されます。init.jsファイルをメインで編集します。&lt;/p&gt;

&lt;p&gt;編集後、書き込みたい場合は、Save + Rebootボタンで行えます。このコードやファイルの情報は、端末から読んでいますので、コードを書き換えたら、書き込む前にバックアップを取っておくことをお勧めします。
&lt;img src=&#34;https://dotstud.io/img/blog/145/6.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;サンプルプログラムについて&#34;&gt;サンプルプログラムについて&lt;/h3&gt;

&lt;p&gt;デフォルトプログラムを僕の感性でコメントしましたので、ご確認ください。なお、色々と制限付きのJSなので、仕様は&lt;a href=&#34;https://github.com/cesanta/mjs&#34;&gt;こちら&lt;/a&gt;で確認ください。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-js:init.js&#34;&gt;// 利用するAPIを読み出します。Flashした時点のサンプルAPIが呼ばれています。
// 各APIの仕様やサンプルは画面左のファイル一覧で参照可能です。
load(&#39;api_config.js&#39;);
load(&#39;api_events.js&#39;);
load(&#39;api_gpio.js&#39;);
load(&#39;api_mqtt.js&#39;);
load(&#39;api_net.js&#39;);
load(&#39;api_sys.js&#39;);
load(&#39;api_timer.js&#39;);

// 変数宣言はletのみです。const, varは使えません。
let led = Cfg.get(&#39;pins.led&#39;);
let button = Cfg.get(&#39;pins.button&#39;);
let topic = &#39;/devices/&#39; + Cfg.get(&#39;device.id&#39;) + &#39;/events&#39;;

print(&#39;LED GPIO:&#39;, led, &#39;button GPIO:&#39;, button);

let getInfo = function() {
  return JSON.stringify({
    total_ram: Sys.total_ram(),
    free_ram: Sys.free_ram()
  });
};

// 1秒おきにLEDをチカチカさせてます。ついでにチクタク時を刻んでいます。
GPIO.set_mode(led, GPIO.MODE_OUTPUT);
Timer.set(1000 /* 1 sec */, Timer.REPEAT, function() {
  let value = GPIO.toggle(led);
  print(value ? &#39;Tick&#39; : &#39;Tock&#39;, &#39;uptime:&#39;, Sys.uptime(), getInfo());
}, null);

// リセットボタンではない方のボタンを押すとMQTTでpublishします。
GPIO.set_button_handler(button, GPIO.PULL_UP, GPIO.INT_EDGE_NEG, 200, function() {
  let message = getInfo();
  let ok = MQTT.pub(topic, message, 1);
  print(&#39;Published:&#39;, ok, topic, &#39;-&amp;gt;&#39;, message);
}, null);

// ネットワークモニタです。
Event.addGroupHandler(Net.EVENT_GRP, function(ev, evdata, arg) {
  let evs = &#39;???&#39;;
  if (ev === Net.STATUS_DISCONNECTED) {
    evs = &#39;DISCONNECTED&#39;;
  } else if (ev === Net.STATUS_CONNECTING) {
    evs = &#39;CONNECTING&#39;;
  } else if (ev === Net.STATUS_CONNECTED) {
    evs = &#39;CONNECTED&#39;;
  } else if (ev === Net.STATUS_GOT_IP) {
    evs = &#39;GOT_IP&#39;;
  }
  print(&#39;== Net event:&#39;, ev, evs);
}, null);

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;nefry-btのフルカラーledを点灯しよう&#34;&gt;Nefry BTのフルカラーLEDを点灯しよう&lt;/h2&gt;

&lt;p&gt;やっと本題に入ります。&lt;/p&gt;

&lt;p&gt;Mongoose OSでは、様々なオープンソースコードがあり、それをインポートすることができます。今回は、NefryBTのフルカラーLEDを点灯させるためにNeoPixelのサンプルコードを入手します。&lt;/p&gt;

&lt;p&gt;画面左のProjectsを選択し、Importをクリックします。
&lt;img src=&#34;https://dotstud.io/img/blog/145/7.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;App Managerのサーチ部分に「neopixel」と入力し、HARDWAREから「example-neopixel-js」をimportします。完了したらApp Managerの画面を閉じます。
&lt;img src=&#34;https://dotstud.io/img/blog/145/8.png&#34; alt=&#34;&#34; /&gt;
次に、サンプルプログラムをNefryBTに書き込みます。&lt;/p&gt;

&lt;p&gt;今ImportしたAppが選択されていることを確認し、①Rebuildアイコンと②Flashアイコンを処理が完了次第、順番にクリックすることで書き込み完了です。（それぞれ少々時間がかかります。）
&lt;img src=&#34;https://dotstud.io/img/blog/145/9.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Device Filesのinit.jsの内容を以下の内容に書き換えます。Nefry BTのボタンを押したらフルカラーLEDが点灯するという内容のプログラムです。&lt;/p&gt;

&lt;p&gt;※なお、R2に関しては動作確認中ですので、確認次第内容を変更いたします。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-js:init.js&#34;&gt;load(&#39;api_config.js&#39;);
load(&#39;api_events.js&#39;);
load(&#39;api_gpio.js&#39;);
load(&#39;api_sys.js&#39;);
load(&#39;api_timer.js&#39;);
load(&#39;api_neopixel.js&#39;);

// 今回は一部しか利用していませんが、NefryのピンNoです。
let pin = {
    &amp;quot;nefrybt&amp;quot;:{
      &amp;quot;sw&amp;quot;: 4,
      &amp;quot;d0&amp;quot;:22,
      &amp;quot;d1&amp;quot;:21,
      &amp;quot;d2&amp;quot;:23,
      &amp;quot;d3&amp;quot;:19,
      &amp;quot;d4&amp;quot;:18,
      &amp;quot;a0&amp;quot;:25,
      &amp;quot;a1&amp;quot;:26,
      &amp;quot;a2&amp;quot;:32,
      &amp;quot;a3&amp;quot;:33,
      &amp;quot;a4&amp;quot;:27,
      &amp;quot;a5&amp;quot;:14,
      &amp;quot;a6&amp;quot;:13,
      &amp;quot;a7&amp;quot;:35,
      &amp;quot;LED&amp;quot;:16
    },
    &amp;quot;nefrybtR2&amp;quot;:{
      &amp;quot;sw&amp;quot;: 4,
      &amp;quot;d0&amp;quot;:22,
      &amp;quot;d1&amp;quot;:21,
      &amp;quot;d2&amp;quot;:23,
      &amp;quot;d3&amp;quot;:19,
      &amp;quot;d4&amp;quot;:18,
      &amp;quot;d5&amp;quot;:25,
      &amp;quot;d6&amp;quot;:26,
      &amp;quot;d7&amp;quot;:13,
      &amp;quot;d8&amp;quot;:14,
      &amp;quot;a0&amp;quot;:33,
      &amp;quot;a1&amp;quot;:32,
      &amp;quot;a2&amp;quot;:39,
      &amp;quot;a3&amp;quot;:36,
      &amp;quot;LED&amp;quot;:16
    }
  };


// フルカラーLEDのピンと個数、オーダーを指定しています。
let Lpin = pin.nefrybt.LED, numPixels = 1, colorOrder = NeoPixel.GRB;

// api_neopixel.jsに基づき初期化を行います。
let strip = NeoPixel.create(Lpin, numPixels, colorOrder);
strip.clear();
strip.setPixel(0,0,0,0);
strip.show();

// ボタンを押したら赤色をつけます。setpixel(0,0,0,0)は、ピクセルナンバーとRGBになっています。Redの数字は20としていますが、数字をあげるとかなり明るくなります。
// GPIO.set_button_handlerの仕様は、
GPIO.set_button_handler(4, GPIO.PULL_UP, GPIO.INT_EDGE_NEG, 200, function() {
    strip.clear();
    strip.setPixel(0,20,0,0);
    strip.show();
}, null);
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;困った時は&#34;&gt;困った時は&lt;/h2&gt;

&lt;p&gt;Q. DeviceLogsにエラーがでている。&lt;/p&gt;

&lt;p&gt;A. Mongoose OS画面右上のdevice setupより、ポートを選択し直してください。それでも治らない場合は、ターミナルにて、&lt;code&gt;control+c&lt;/code&gt;でMongoose OSを一度終わらせて、再起動をしてみてください。&lt;/p&gt;

&lt;p&gt;それでもエラーが発生する場合は、一度Arduino IDEからNefry BTをボードに選択し、何も書いていないコードで書き込み直してください。なお、Nefry BTの状態に戻したい場合もArduino IDEから書き込むことで初期状態にもどせます。&lt;/p&gt;

&lt;h2 id=&#34;まとめ&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;Nefry BTをJavaScriptでプログラムして、LEDを点灯させるところまでできました。&lt;/p&gt;

&lt;p&gt;ディスプレイも表示させることができるので、次回は、Mongoose OSを使ったディスプレイの表示方法をご紹介しようと思います。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Nefry BT（ESP32）からBLEでNode.jsにデータを送ってみよう</title>
      <link>https://dotstud.io/blog/nefrybt-ble-bluetooth-peripheral/</link>
      <pubDate>Fri, 12 Jan 2018 23:58:16 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/nefrybt-ble-bluetooth-peripheral/</guid>
      
      <description>

&lt;p&gt;こんにちは、代表ののびすけ（&lt;a href=&#34;https://twitter.com/n0bisuke&#34;&gt;@n0bisuke&lt;/a&gt;）です。Nefry BTを使ってBluetooth / BLEを利用する方法を紹介します。&lt;/p&gt;

&lt;p&gt;ほぼESP32のコードなので、検証してませんが他のESP32系のボードでも動作すると思います。&lt;/p&gt;

&lt;h2 id=&#34;bleについて&#34;&gt;BLEについて&lt;/h2&gt;

&lt;p&gt;BLEには大きく分け&lt;strong&gt;Peripheral （ペリフェラル）&lt;/strong&gt;と&lt;strong&gt;Central（セントラル）&lt;/strong&gt;という二つの役割があります。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Peripheral: 発信側端末、ビーコンやBLEタグなど受信端末に対して情報を送る側&lt;/li&gt;
&lt;li&gt;Central: 受信側端末、iPhoneやMacなどBLEデバイスの情報を探して受け取る側&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/143/1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Nefry BTは書き込むコードによって、PeripheralにもCentralにもなることができます。&lt;/p&gt;

&lt;h2 id=&#34;環境&#34;&gt;環境&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Arduino IDE 1.8.5&lt;/li&gt;
&lt;li&gt;Nefry ライブラリ 1.1.4&lt;/li&gt;
&lt;li&gt;Nefry BT R2&lt;/li&gt;
&lt;li&gt;macOS High Sierra&lt;/li&gt;
&lt;li&gt;Node.js v9.2.0&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;peripheralの作成&#34;&gt;Peripheralの作成&lt;/h2&gt;

&lt;p&gt;情報発信側のPeripheralをNefry BTで作成します。&lt;/p&gt;

&lt;h3 id=&#34;uuidの作成&#34;&gt;UUIDの作成&lt;/h3&gt;

&lt;p&gt;BLEを利用するためには&lt;strong&gt;SERVICE（サービス）&lt;/strong&gt;と&lt;strong&gt;CHARACTERISTIC（キャラクタリスティック）&lt;/strong&gt;という各機能を司るUUIDを設定する必要があります。プログラミングでいうクラスとメソッドの関係だと思うと良いかもしれません。&lt;/p&gt;

&lt;p&gt;BLEデバイスは部屋の中やカフェ、駅などいたるところに存在するのでそれらのデバイスと自分が所持しているデバイスのIDが競合しないようにユニークな値にする必要があります。そこでUUIDを作成し、設定する必要があります。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.uuidgenerator.net/&#34;&gt;https://www.uuidgenerator.net/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/143/2.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;このサイトでUUIDが作成出きるので各自作成しましょう。&lt;/p&gt;

&lt;h3 id=&#34;nefry-btのスケッチ&#34;&gt;Nefry BTのスケッチ&lt;/h3&gt;

&lt;p&gt;大元のコードはnkolban氏の&lt;a href=&#34;https://github.com/nkolban/ESP32_BLE_Arduino/blob/f8fe9d7cdfb20caa54b70849826d1ac6e375ff78/examples/BLE_notify/BLE_notify.ino&#34;&gt;こちらのコード&lt;/a&gt;です。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;#define SERVICE_UUID&lt;/code&gt;の箇所と&lt;code&gt;#define CHARACTERISTIC_UUID&lt;/code&gt;の箇所に先ほど作成したUUIDを指定します。&lt;/p&gt;

&lt;p&gt;また&lt;code&gt;BLEDevice::init(&amp;quot;&amp;quot;);&lt;/code&gt;の箇所にBLEデバイスの名前を設定できます。
以下のコードではNefryBT-n0bisukeという名前を指定しています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;BLEDevice.h&amp;gt;
#include &amp;lt;BLEServer.h&amp;gt;
#include &amp;lt;BLEUtils.h&amp;gt;
#include &amp;lt;BLE2902.h&amp;gt;

BLECharacteristic *pCharacteristic;
bool deviceConnected = false;
uint8_t value = 0;

// See the following for generating UUIDs:
// https://www.uuidgenerator.net/

#define SERVICE_UUID        &amp;quot;D5875408-FA51-4763-A75D-7D33CECEBC31&amp;quot;
#define CHARACTERISTIC_UUID &amp;quot;A4F01D8C-A037-43B6-9050-1876A8C23584&amp;quot;

class MyServerCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) {
      deviceConnected = true;
    };

    void onDisconnect(BLEServer* pServer) {
      deviceConnected = false;
    }
};

void setup() {
  Serial.begin(115200);

  // Create the BLE Device
  BLEDevice::init(&amp;quot;NefryBT-n0bisuke&amp;quot;);

  // Create the BLE Server
  BLEServer *pServer = BLEDevice::createServer();
  pServer-&amp;gt;setCallbacks(new MyServerCallbacks());

  // Create the BLE Service
  BLEService *pService = pServer-&amp;gt;createService(SERVICE_UUID);

  // Create a BLE Characteristic
  pCharacteristic = pService-&amp;gt;createCharacteristic(
                      CHARACTERISTIC_UUID,
                      BLECharacteristic::PROPERTY_READ   |
                      BLECharacteristic::PROPERTY_WRITE  |
                      BLECharacteristic::PROPERTY_NOTIFY |
                      BLECharacteristic::PROPERTY_INDICATE
                    );

  // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.descriptor.gatt.client_characteristic_configuration.xml
  // Create a BLE Descriptor
  pCharacteristic-&amp;gt;addDescriptor(new BLE2902());

  // Start the service
  pService-&amp;gt;start();

  // Start advertising
  pServer-&amp;gt;getAdvertising()-&amp;gt;start();
  Serial.println(&amp;quot;Waiting a client connection to notify...&amp;quot;);
}

void loop() {

  if (deviceConnected) {
    Serial.printf(&amp;quot;*** NOTIFY: %d ***\n&amp;quot;, value);
    char buffer[10];
    sprintf(buffer, &amp;quot;{\&amp;quot;val\&amp;quot;:%d}&amp;quot;, value);
    Serial.printf(buffer);
    pCharacteristic-&amp;gt;setValue(buffer);
    pCharacteristic-&amp;gt;notify();
    //pCharacteristic-&amp;gt;indicate();
    value++;
  }
  delay(2000);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;コンパイルエラーが出ないで書き込みが出来ればOKです。&lt;/p&gt;

&lt;h3 id=&#34;確認&#34;&gt;確認&lt;/h3&gt;

&lt;p&gt;デバッグには&lt;a href=&#34;https://itunes.apple.com/jp/app/lightblue/id639944780?mt=12&#34;&gt;LightBlue&lt;/a&gt;などのBLEデバッグ用のアプリケーションを利用することをお勧めします。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/143/3.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Nefry BTが起動すると先ほど指定した&lt;strong&gt;NefryBT-n0bisuke&lt;/strong&gt;という名前でBLEデバイスが検出されます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/143/4.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;SERVICEのUUIDやCHARACTERISTICのUUIDも先ほど指定したものが表示されていると思います。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;これで問題なく、Nefry BTから情報が発信されていることが確認出来ました。&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&#34;centralの作成&#34;&gt;Centralの作成&lt;/h2&gt;

&lt;p&gt;次は受信側のCentralを作成していきます。
データの確認だけであれば先ほどのLightBlueなどのアプリで確認でも良いのですが、自分のサービスに組み込む際には何かしらのプログラミング言語でアクセスできた方が都合が良いです。&lt;/p&gt;

&lt;h3 id=&#34;nobleの利用&#34;&gt;nobleの利用&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/sandeepmistry/noble&#34;&gt;noble&lt;/a&gt;はNode.js向けのBLEライブラリです。MacやWindows、Raspberry PiなどのデバイスをBLEのCentralにすることができます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir ble_central
cd ble_central
touch app.js
npm init -y
npm i --save noble
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これで準備とnobleのインストールが完了しました。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;app.js&lt;/code&gt;に以下を記述します。SERVICE_UUIDやCHARACTERISTIC_UUIDは自分で作成したNefry BT側に書き込んだUUIDと同様のものを指定しましょう。&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;[WIP] Async/Awaitに書き換えたい。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code&gt;&#39;use strict&#39;;

const noble = require(&#39;noble&#39;);
const serviceuuid = `d5875408fa514763a75d7d33cecebc31`;
const charauuid = `a4f01d8ca03743b690501876a8c23584`;

//キャラクタリスティックにアクセスしてデータやりとり
const accessChara = (chara) =&amp;gt; {
    console.log(&#39;-----Start GATT Access-----&#39;)
    chara.notify(true, (err) =&amp;gt; {
        if (err) {
          console.log(&#39;listen notif error&#39;, err)
        } else {
          console.log(&#39;listen notif&#39;)
        }
    });
    chara.on(&#39;data&#39;, (data, isNotif) =&amp;gt; {
        const jsonStr = data.toString(&#39;utf-8&#39;);
        const jsonData = JSON.parse(jsonStr);
        console.log(jsonData);
    });
}


//discovered BLE device
const discovered = (peripheral) =&amp;gt; {
    console.log(`BLE Device Found: ${peripheral.advertisement.localName}(${peripheral.uuid}) RSSI${peripheral.rssi}`);

    if(peripheral.advertisement.localName === &#39;NefryBT-n0bisuke&#39;){
        noble.stopScanning();
        console.log(&#39;device found&#39;);
        console.log(`service discover...`);

        peripheral.connect(error =&amp;gt; {
            if (error) {
                console.log(&amp;quot;connection error:&amp;quot;, error)
            } else {
                console.log(&amp;quot;device connected&amp;quot;);
            }

            peripheral.discoverServices([],(err, services) =&amp;gt; {
                if (error) {
                    console.log(&amp;quot;discover service error&amp;quot;, error)
                }
                console.log(&#39;discover service&#39;);               
                services.forEach(service =&amp;gt; {
                    if(service.uuid === serviceuuid){
                        service.discoverCharacteristics([], (error, charas) =&amp;gt; {
                            console.log(&#39;discover chara&#39;);
                            charas.forEach(chara =&amp;gt; {
                                if(chara.uuid === charauuid){
                                    console.log(&amp;quot;found chara: &amp;quot;, chara.uuid)
                                    accessChara(chara);
                                }
                            });
                        });
                    }
                });
            });
        });
    }
}

//BLE scan start
const scanStart = () =&amp;gt; {
    noble.startScanning();
    noble.on(&#39;discover&#39;, discovered);
}

if(noble.state === &#39;poweredOn&#39;){
    scanStart();
}else{
    noble.on(&#39;stateChange&#39;, scanStart);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;実行&#34;&gt;実行&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;node app.js
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で実行します。この時、先ほどのLightBlueなどのアプリでNefryBTにBLEアクセスしていると上手くいかないのでアプリ側の接続は解除しましょう。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/143/5.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Mac側のNode.jsのログはこんな感じで表示されます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;BLE Device Found: LED(59aa15c3a3274ed7b11d334b5c0d0900) RSSI-68
BLE Device Found: NefryBT-n0bisuke(d0b77d4611f54380b8b63e6d05765ad6) RSSI-49
device found
service discover...
device connected
discover service
discover chara
found chara:  a4f01d8ca03743b690501876a8c23584
-----Start GATT Access-----
listen notif
{ val: 147 }
{ val: 148 }
・
・
・
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;解説&#34;&gt;解説&lt;/h3&gt;

&lt;p&gt;NefryBT側ではデバイスにアクセスがありCentralとのコネクションが確立すると、&lt;code&gt;変数value&lt;/code&gt;の値をセット(pCharacteristic-&amp;gt;setValue)して送信（pCharacteristic-&amp;gt;notify）し、valueの値をインクリメントします。&lt;/p&gt;

&lt;p&gt;これを2秒ごとに行うので2秒間隔でNefryBTからMacのNode.jsに情報が送信されます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;・
(省略)
・
・
void loop() {

  if (deviceConnected) {
    Serial.printf(&amp;quot;*** NOTIFY: %d ***\n&amp;quot;, value);
    char buffer[10];
    sprintf(buffer, &amp;quot;{\&amp;quot;val\&amp;quot;:%d}&amp;quot;, value);
    Serial.printf(buffer);
    pCharacteristic-&amp;gt;setValue(buffer);
    pCharacteristic-&amp;gt;notify();
    //pCharacteristic-&amp;gt;indicate();
    value++;
  }
  delay(2000);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Node.js（noble）側では、PERIPHERAL -&amp;gt; SERVICE -&amp;gt; CHARACTERISTICと階層的にアクセスしていき、CHARACTERISTICまでアクセスが出きると、accessChara関数が呼ばれます。&lt;/p&gt;

&lt;p&gt;この中の&lt;code&gt;chara.on(&#39;data&#39;)&lt;/code&gt;の箇所でデータが送られてくるたびにイベントが発火して、データの中身を確認できます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;・
・
(省略)
・
const accessChara = (chara) =&amp;gt; {
    console.log(&#39;-----Start GATT Access-----&#39;)
    chara.notify(true, (err) =&amp;gt; {
        if (err) {
          console.log(&#39;listen notif error&#39;, err)
        } else {
          console.log(&#39;listen notif&#39;)
        }
    });
    chara.on(&#39;data&#39;, (data, isNotif) =&amp;gt; {
        const jsonStr = data.toString(&#39;utf-8&#39;);
        const jsonData = JSON.parse(jsonStr);
        console.log(jsonData);
    });
}
・
・
(省略)
・
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;まとめ&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;Nefry BTでBLEを利用する方法を紹介しました。
Nefry BTでセンサーのデータを取得し、Centralに送信する方法なども応用して作れそうですね。&lt;/p&gt;

&lt;p&gt;これを参考にNefry BTとBLEデバイスの連携などに活用していきましょう。&lt;/p&gt;

&lt;p&gt;今回はNefry BTをPeripheralにする実装でしたが、別の機会でCentralにする方法も紹介できればと思っています。&lt;/p&gt;

&lt;p&gt;それでは！&lt;/p&gt;

&lt;h2 id=&#34;所感&#34;&gt;所感&lt;/h2&gt;

&lt;p&gt;今回の実装ですが色々と途中でのハマりが多いかつ、調べてもまだまだESP32のBLE利用をArduinoでやってる事例は少なくけっこう大変でした。この辺の大変だった知見はQiitaなどでまとめらたらと思っています。お疲れ様です笑&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Nefry BT（ESP32）でMQTTを使ってみよう Subscribe編</title>
      <link>https://dotstud.io/blog/nefry-bt-connect-mqtt/</link>
      <pubDate>Sat, 06 Jan 2018 14:28:04 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/nefry-bt-connect-mqtt/</guid>
      
      <description>

&lt;p&gt;あけましておめでとうございます。 代表ののびすけ（&lt;a href=&#34;https://twitter.com/n0bisuke&#34;&gt;@n0bisuke&lt;/a&gt;）です。&lt;/p&gt;

&lt;p&gt;Nefry BTを使ってMQTTを利用する方法を紹介します。&lt;/p&gt;

&lt;p&gt;今回はMQTTでNefry BTに情報を送信してみます。&lt;/p&gt;

&lt;p&gt;ほぼESP32のコードなので、ESP32系の他のボードを利用している人の参考にもなると思います。&lt;/p&gt;

&lt;h2 id=&#34;mqttの登場人物&#34;&gt;MQTTの登場人物&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Broker - 通信のサーバー&lt;/li&gt;
&lt;li&gt;Publisher - 情報の送信側&lt;/li&gt;
&lt;li&gt;Subscriber - 情報の受信側&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;WebSocketではサーバーとクライアントだけで双方向通信をしますが、MQTTではサーバーはBrocker、クライアント側が送信者のPublisherと受信者のSubscriberに分かれます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/141/1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;今回はNefry BTをSubscriber（受信者）にして、外部からNefry BTに情報を送ってみたいと思います。&lt;/p&gt;

&lt;h2 id=&#34;環境&#34;&gt;環境&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Arduino IDE 1.8.5&lt;/li&gt;
&lt;li&gt;Nefry ライブラリ 1.1.4&lt;/li&gt;
&lt;li&gt;Nefry BT R2&lt;/li&gt;
&lt;li&gt;macOS High Sierra&lt;/li&gt;
&lt;li&gt;Node.js v9.2.0&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;subscriberの作成&#34;&gt;Subscriberの作成&lt;/h2&gt;

&lt;h3 id=&#34;arduino向けのmqttライブラリをインストール&#34;&gt;Arduino向けのMQTTライブラリをインストール&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/knolleary/pubsubclient&#34;&gt;knolleary/pubsubclient&lt;/a&gt;を利用します。&lt;/p&gt;

&lt;p&gt;zipファイルをダウンロードしたら、 &lt;code&gt;スケッチ &amp;gt; ライブラリのインポート &amp;gt; .ZIP形式のライブラリをインストール&lt;/code&gt;からArduino IDEにライブラリをインストールします。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/141/2.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;nefry-btのスケッチ&#34;&gt;Nefry BTのスケッチ&lt;/h3&gt;

&lt;p&gt;ブローカーは&lt;a href=&#34;https://mosquitto.org/&#34;&gt;Mosquitto&lt;/a&gt;を利用します。&lt;/p&gt;

&lt;p&gt;&amp;ldquo;mosquitto.org&amp;rdquo;の&amp;rdquo;n0bisuke&amp;rdquo;という名前のトピックに情報が送信されたら受信します。&lt;/p&gt;

&lt;p&gt;MQTTはデフォルト1883ポートを利用するので、1883ポートを指定します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;Nefry.h&amp;gt;
#include &amp;lt;PubSubClient.h&amp;gt;

WiFiClient httpsClient;
PubSubClient mqttClient(httpsClient);

#define TOPIC &amp;quot;n0bisuke&amp;quot;
#define QOS 0
#define URL &amp;quot;mosquitto.org&amp;quot;
#define PORT 1883

void setup() {
  mqttClient.setServer(URL, PORT);
  mqttClient.setCallback(callback);
}

void loop() {
  if(!mqttClient.connected()) {
    if (mqttClient.connect(TOPIC)) {
      Serial.println(&amp;quot;Connected.&amp;quot;);    
      mqttClient.subscribe(TOPIC, QOS);
      Serial.println(&amp;quot;Subscribed.&amp;quot;);
    }
    else {
      errorReport();
    }
  }

  mqttClient.loop();
}

void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print(&amp;quot;Message arrived [&amp;quot;);
  Serial.print(topic);
  Serial.print(&amp;quot;] &amp;quot;);
  for (int i = 0; i &amp;lt; length; i++) {
    Serial.print((char)payload[i]);
  }
  Serial.println();
}

void errorReport(){
  Serial.print(&amp;quot;Failed. Error state = &amp;quot;);

  switch (mqttClient.state()) {
    case MQTT_CONNECT_UNAUTHORIZED:
      Serial.println(&amp;quot;MQTT_CONNECT_UNAUTHORIZED&amp;quot;);
      break;
    case MQTT_CONNECT_BAD_CREDENTIALS:
      Serial.println(&amp;quot;MQTT_CONNECT_BAD_CREDENTIALS&amp;quot;);
      break;
    case MQTT_CONNECT_UNAVAILABLE:
      Serial.println(&amp;quot;MQTT_CONNECT_UNAVAILABLE&amp;quot;);
      break;
    case MQTT_CONNECT_BAD_CLIENT_ID:
      Serial.println(&amp;quot;MQTT_CONNECT_BAD_CLIENT_ID&amp;quot;);
      break;
    case MQTT_CONNECT_BAD_PROTOCOL:
      Serial.println(&amp;quot;MQTT_CONNECT_BAD_PROTOCOL&amp;quot;);
      break;
    case MQTT_CONNECTED:
      Serial.println(&amp;quot;MQTT_CONNECTED&amp;quot;);
      break;
    case MQTT_DISCONNECTED:
      Serial.println(&amp;quot;MQTT_DISCONNECTED&amp;quot;);
      break;
    case MQTT_CONNECT_FAILED:
      Serial.println(&amp;quot;MQTT_CONNECT_FAILED&amp;quot;);
      break;
    case MQTT_CONNECTION_LOST:
      Serial.println(&amp;quot;MQTT_CONNECTION_LOST&amp;quot;);
      break;
    case MQTT_CONNECTION_TIMEOUT:
      Serial.println(&amp;quot;MQTT_CONNECTION_TIMEOUT&amp;quot;);
      break;
  }

  delay(5000); // Wait 5 seconds before retrying
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;publisherの作成&#34;&gt;Publisherの作成&lt;/h2&gt;

&lt;p&gt;情報の送信側であるPublisherは手元のMac Book上のNode.jsで作成しました。&lt;/p&gt;

&lt;p&gt;Node.jsでMQTTを利用する場合は&lt;a href=&#34;https://www.npmjs.com/package/mqtt&#34;&gt;mqtt.js&lt;/a&gt;を利用するのが手頃です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir mqtt-test
cd mqtt-test
npm init -y
npm i --save mqtt
touch publisher.js
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;//publisher.js
&#39;use strict&#39;;

const mqtt = require(&#39;mqtt&#39;);
const client = mqtt.connect(&#39;mqtt://mosquitto.org&#39;);

client.on(&#39;connect&#39;, () =&amp;gt; console.log(&#39;publisher.connected.&#39;));

setInterval(() =&amp;gt; {
    const message = Date.now().toString();
    client.publish(&#39;n0bisuke&#39;, message);
    console.log(&#39;publisher.publish:&#39;, message);
}, 1000);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これで実行すると、以下のように時間の情報をパブリッシュ（送信）し始めます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;node publisher.js

publisher.publish: 1515219086876
publisher.publish: 1515219087879
publisher.publish: 1515219088880
publisher.publish: 1515219089882
・
・
・
(省略)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/141/3.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;所感&#34;&gt;所感&lt;/h2&gt;

&lt;p&gt;思ってたより簡単に実装出来ました。
これを参考にNefry BTとWebサービスの連携などに活用していきましょう。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://www.mosca.io/&#34;&gt;Mosca&lt;/a&gt;などを使うとBrokerも自分で作成することが出来るので試してみると良いかもしれません。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Node.jsとNefry BTで監視システムを作ろう！ for Pepper #iotlt</title>
      <link>https://dotstud.io/blog/nefrybt-pepper-monitoring-system/</link>
      <pubDate>Thu, 21 Sep 2017 18:40:38 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/nefrybt-pepper-monitoring-system/</guid>
      
      <description>

&lt;p&gt;こんにちは、のびすけです。&lt;/p&gt;

&lt;p&gt;IoTLT vol31で話をしたNefry BT（ESP32系ボード）を使ってネットワークカメラを作ってみたいと思います。&lt;/p&gt;

&lt;p&gt;発表資料もご参照ください。&lt;/p&gt;

&lt;script async class=&#34;speakerdeck-embed&#34; data-id=&#34;a4d673e00b57428ebe22543efda38f6f&#34; data-ratio=&#34;1.33333333333333&#34; src=&#34;//speakerdeck.com/assets/embed.js&#34;&gt;&lt;/script&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://speakerdeck.com/n0bisuke/pepperlian-xi-falsejian-shi-sisutemu-number-iotlt&#34;&gt;Pepper連携の監視システム? #iotlt by n0bisuke&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&#34;https://dotstudio.connpass.com/event/61189/&#34;&gt;Nefry BTのハンズオン&lt;/a&gt;も開催しますので合わせてご覧ください。&lt;/p&gt;

&lt;h2 id=&#34;やりたいこと&#34;&gt;やりたいこと&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Pepperを監視したい。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;謎ですが、Pepperを監視したいです。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://iotlt.connpass.com/event/65379/&#34;&gt;IoTLT vol31&lt;/a&gt;で話をした内容ですが、Pepperが動いてくれないので、Pepperがいつ動き出しても大丈夫なように&lt;strong&gt;Pepperを見守り&lt;/strong&gt;します。&lt;/p&gt;

&lt;p&gt;巷では「Pepperが見守り」だったり、「Pepperが防犯」みたいな先進的な取り組みがありますが、僕は&lt;strong&gt;あえてPepperを見守ります。&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&#34;完成イメージ&#34;&gt;完成イメージ&lt;/h2&gt;

&lt;p&gt;こんな感じで見守ります。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/c3fa7c7bb7dbdd5bba505e7a3de3b54b.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;そして、外からでもブラウザでPepperを見守るストリーミングサービスっぽいものを作ります。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/09e912583e26710a13f0d49f4a866b55.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;使うもの&#34;&gt;使うもの&lt;/h2&gt;

&lt;p&gt;デバイスはNefry BTとGroveカメラの二つです。
（ちょっとジャンパワイヤ使います。）&lt;/p&gt;

&lt;h3 id=&#34;nefry-bt&#34;&gt;Nefry BT&lt;/h3&gt;

&lt;p&gt;ESP32ベースのArduino互換開発ボードです。
&lt;a href=&#34;http://sengoku.co.jp/mod/sgk_cart/detail.php?code=EEHD-55W8&#34;&gt;千石電商さん&lt;/a&gt;でも購入できます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/d43d9926b0e5293b1045890bdd7fbc6c.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;grove-シリアルカメラキット&#34;&gt;Grove シリアルカメラキット&lt;/h3&gt;

&lt;p&gt;Grove対応のカメラです。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.switch-science.com/catalog/1626/&#34;&gt;スイッチサイエンスさん&lt;/a&gt;などで購入できます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/99ad24d2ffcfd62c8407d7db7fb753c5.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;構成イメージ&#34;&gt;構成イメージ&lt;/h2&gt;

&lt;p&gt;カメラで撮影した画像をNefry BT経由でサーバーにアップロードします。
アップロードされた画像はNode.jsで立てたサーバーで受け取り、WebSocket(Socket.io)でブラウザに配信します。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/bfdd4f3e37898144268c2edd086320dc.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;作り方&#34;&gt;作り方&lt;/h2&gt;

&lt;p&gt;3つに分けて紹介します。&lt;/p&gt;

&lt;p&gt;デバイス（Nefry BT）で撮影した画像をサーバーに送りサーバーからブラウザに配信します。&lt;/p&gt;

&lt;p&gt;データの流れ的に&lt;code&gt;デバイス -&amp;gt; サーバー -&amp;gt; ブラウザ&lt;/code&gt;という流れです。&lt;/p&gt;

&lt;p&gt;全体のコードは&lt;a href=&#34;https://github.com/dotstudio/nefrybt_camera_server&#34;&gt;こちらのGitHubリポジトリ&lt;/a&gt;にあります。&lt;/p&gt;

&lt;h3 id=&#34;デバイス側-arduino&#34;&gt;デバイス側 - Arduino&lt;/h3&gt;

&lt;p&gt;デバイス側は&lt;a href=&#34;http://wiki.seeed.cc/Grove-Serial_Camera_Kit/&#34;&gt;Grove - Serial Camera Kitの公式Wiki&lt;/a&gt;にあるサンプルコードをもとに作っています。&lt;/p&gt;

&lt;p&gt;dotstudioの&lt;a href=&#34;https://dotstud.io/members/ukkz/&#34;&gt;ものづくりアーティストうこ&lt;/a&gt;さんがメインで作ってくれました。&lt;/p&gt;

&lt;p&gt;少し長いので&lt;a href=&#34;https://github.com/dotstudio/nefrybt_camera_server/blob/master/nefry/nefrybt_grove_camera/nefrybt_grove_camera.ino&#34;&gt;GitHubのリポジトリ&lt;/a&gt;を参照しましょう。&lt;/p&gt;

&lt;p&gt;このプログラムをNefry BTに書き込みましょう。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;host&lt;/code&gt;の箇所に画像アップロード先のサーバーを指定します。&lt;/p&gt;

&lt;h4 id=&#34;配線&#34;&gt;配線&lt;/h4&gt;

&lt;p&gt;配線はD3,D4に繋ぎます。&lt;/p&gt;

&lt;p&gt;プログラム的には&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#define SEREAL_RX 19 //Nefry BT D3
#define SEREAL_TX 18 //Nefry BT D4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;の部分が該当します。NefryBTの&lt;a href=&#34;https://drive.google.com/file/d/0B_mvDQF8yaQRLVprUHl4WTFLWVE/view&#34;&gt;仕様書&lt;/a&gt;を見ると分かりますが、ESP32のGPIO 19番がNefryBTのD3にあたり、18番がD4になります。&lt;/p&gt;

&lt;h3 id=&#34;サーバー側-node-js&#34;&gt;サーバー側 - Node.js&lt;/h3&gt;

&lt;p&gt;Node.jsで画像を受信するサーバーを作ります。&lt;/p&gt;

&lt;p&gt;無難にSocket.ioとexpressを使います。 Node.jsのバージョンは8.4です。
7系以前だと動かない可能性があります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;npm i --save socket.io express
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;//server.js
&#39;use strict&#39;;

const fs = require(&#39;fs&#39;);
const app = require(&#39;express&#39;)();
const http = require(&#39;http&#39;).Server(app);
const io = require(&#39;socket.io&#39;)(http);
const express = require(&#39;express&#39;);
const PORT = process.env.PORT || 3000;
app.use(express.static(__dirname));

const {promisify} = require(&#39;util&#39;);
const writeFileAsync = promisify(fs.writeFile);

io.on(&#39;connection&#39;, (socket) =&amp;gt; console.log(&#39;a user connected&#39;)); //socket.ioのコネクション

app.get(&#39;/&#39;, (req, res) =&amp;gt; res.sendFile(&#39;./index.thml&#39;));
app.post(&#39;/&#39;, (req, res) =&amp;gt; {
    let buffers = [];
    let cur = 0;
    const len = parseInt(req.headers[&#39;content-length&#39;], 10);

    req.on(&#39;data&#39;, (chunk) =&amp;gt; {
        buffers.push(chunk);
        cur += chunk.length;
        console.log(`Downloading...${(100.0 * cur / len).toFixed(2)}%`);
    });

    req.on(&#39;end&#39;, async () =&amp;gt; {
        console.log(`\n[done] Image upload`);
        req.rawBody = Buffer.concat(buffers);
        const base64image = req.rawBody.toString(&#39;base64&#39;); //base64変換
        await writeFileAsync(&#39;./img.jpeg&#39;, req.rawBody, &#39;utf-8&#39;)
        console.log(`[done] Image Save`);
        io.sockets.emit(&#39;new image&#39;,base64image); //画像送信
    });

});

http.listen(PORT, () =&amp;gt; console.log(`listening on *:${PORT}`));
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;通常Expressを使う際に&lt;a href=&#34;https://github.com/expressjs/body-parser&#34;&gt;body-parser&lt;/a&gt;をよく使いますが、今回はあえて使わずに、&lt;code&gt;dataイベント&lt;/code&gt;で&lt;code&gt;chunk&lt;/code&gt;を拾って画像アップロードのプログレス表示を実装しています。&lt;/p&gt;

&lt;p&gt;Nefry BTも含めてこういったマイコンボードはスマートフォンやPCに比べるとCPUパワーが弱いため、画像アップロードに時間がかかることがあります。&lt;/p&gt;

&lt;p&gt;サーバー側でどれくらいのデータ送信が完了しているのかの進捗が分かると安心して開発できます。
画像を受信したら&lt;code&gt;toString(&#39;base64&#39;)&lt;/code&gt;でBase64の文字列に変換をしています。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;io.sockets.emit()&lt;/code&gt;の箇所では変換した文字列をSocket.io経由でブラウザに配信しています。&lt;/p&gt;

&lt;h3 id=&#34;ブラウザ側-javascript&#34;&gt;ブラウザ側 - JavaScript&lt;/h3&gt;

&lt;p&gt;ブラウザ側では、文字列で送られた画像データを受け取り、Canvasに流し込みます。
HTML側では&lt;code&gt;id=&amp;quot;myCanvas&amp;quot;&lt;/code&gt;のcanvasを作り、&lt;code&gt;socket.io&lt;/code&gt;の読み込みと以下で作る&lt;code&gt;app.js&lt;/code&gt;の読み込みをします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
    &amp;lt;meta charset=&amp;quot;utf-8&amp;quot; /&amp;gt;
    &amp;lt;title&amp;gt;Nefry BT Camera&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;

&amp;lt;body style=&amp;quot;background-color:#D0D0D0;&amp;quot;&amp;gt;
    &amp;lt;canvas id=&amp;quot;myCanvas&amp;quot; width=&amp;quot;640&amp;quot; height=&amp;quot;480&amp;quot; style=&amp;quot;background-color:#FFFFFF;&amp;quot;&amp;gt;&amp;lt;/canvas&amp;gt;
    &amp;lt;script src=&amp;quot;/socket.io/socket.io.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script src=&amp;quot;/public/app.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;draw()&lt;/code&gt;では、canvasに&lt;code&gt;drawImage()&lt;/code&gt;で画像を描画します。
Base64の場合はsrcが画像パスではなく&lt;code&gt;data:image/jpeg;base64,~~~~~&lt;/code&gt;という指定方法です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// /public/app.js
&#39;use strict&#39;;

const socket = io();

const draw = (imageData = &#39;&#39;) =&amp;gt; {
    const canvas = document.getElementById(&#39;myCanvas&#39;);
    const ctx = canvas.getContext(&#39;2d&#39;);
    const img = new Image();
    img.src = `data:image/jpeg;base64,${imageData}`; //基本base64の文字列
    if(imageData === &#39;init&#39;) img.src = `./img.jpeg`; //初期実行時のみサーバーのimg.jpegを取得
    img.onload = () =&amp;gt; {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, 640, 480);
    }
    console.log(`update ${new Date()}`);
}

socket.on(&#39;new image&#39;, draw); //画像更新時
draw(&#39;init&#39;); //初期実行
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;socket.on(&#39;new image&#39;, draw)&lt;/code&gt;でサーバーからデータが送られてくるたびに&lt;code&gt;draw()&lt;/code&gt;を実行します。&lt;/p&gt;

&lt;h2 id=&#34;使ってみた感想&#34;&gt;使ってみた感想&lt;/h2&gt;

&lt;p&gt;1週間ほど動かしていますが、問題なくずっと稼働写真を送り続けてくれるので意外と&lt;strong&gt;ラズパイなどで作るシステムより安定しているかも&lt;/strong&gt;しれません。&lt;/p&gt;

&lt;p&gt;あと、発表のオチだったのですが、Pepperの調子が悪く被写体が動かないので成功してるのか分かりにくいです苦笑&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.gyazo.com/b2fb0a60f31c12e61e99b51d442dd563.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;まとめ&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;Nefry BTとNode.jsを使ってネットワークカメラを作ることができました。&lt;/p&gt;

&lt;p&gt;GroveのカメラとNefry V2を使って過去に&lt;a href=&#34;https://am-our.com/love/110/13945/&#34;&gt;【大島薫×IoT】浮気男を社会的に制裁するマシーンを作ってみた&lt;/a&gt;こともありましたが、ネットワークカメラを作りたい需要はそこそこあると思うので、その際の参考になれば幸いです。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Nefry BTとIFTTTでスイッチを押したらLINEを送る仕組みを作ってみよう</title>
      <link>https://dotstud.io/blog/nefry-ifttt-push-line/</link>
      <pubDate>Thu, 18 May 2017 02:51:27 +0900</pubDate>
      
      <guid>https://dotstud.io/blog/nefry-ifttt-push-line/</guid>
      
      <description>

&lt;p&gt;こんにちは。外部ライターのわみ（&lt;a href=&#34;https://twitter.com/wamisnet&#34;&gt;@wamisnet&lt;/a&gt;）です。Unirobot株式会社でロボットのソフトウェアエンジニアをやりながら、dotstudioでは私が作成しているIoTデバイス「Nefry」シリーズの販売やチュートリアル記事の執筆をしています。&lt;/p&gt;

&lt;p&gt;Nefryは、ユーザの皆様からのフィードバックを頂き成長しています。新たなWi-Fi・BLEモジュール「ESP-WROOM-32」の発売もあり、このたび&lt;strong&gt;新機能と改良を加えた次世代の「Nefry BT」を発表&lt;/strong&gt;する事になりました。&lt;/p&gt;

&lt;p&gt;今回は新しい「Nefry BT」を使って、Amazon Dash Buttonのようにスイッチを押した時にLINEに通知が行く仕組みを作ってみます。&lt;/p&gt;

&lt;h2 id=&#34;nefry-btとは&#34;&gt;Nefry BTとは&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/100/01_nefry.png&#34; alt=&#34;&#34; /&gt;
Nefryシリーズは、「&lt;strong&gt;簡単にインターネットにつながること&lt;/strong&gt;」をテーマにしたFRISKサイズのIoTデバイスです。Nefry BTからはWi-Fiに加えてBLE（Bluetooth Low Energy）に対応し、I/O機能も増えて開発の幅がさらに広がりました！&lt;/p&gt;

&lt;p&gt;ハードウェアをできるだけ意識しなくて済むよう設計され、はんだづけや複雑な接続なしで動かすことができるため、初めてハードウェアを触る方にオススメのデバイスです。&lt;/p&gt;

&lt;h2 id=&#34;作ってみる&#34;&gt;作ってみる&lt;/h2&gt;

&lt;p&gt;今回試す流れは以下です。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;IFTTTにレシピを作成する&lt;/li&gt;
&lt;li&gt;開発環境（Arduino IDE）を整える&lt;/li&gt;
&lt;li&gt;プログラムを書き込む&lt;/li&gt;
&lt;li&gt;Nefry BTとIFTTTを紐付ける&lt;/li&gt;
&lt;li&gt;スイッチを押してLINEにメッセージを送ってみる&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;用意するもの&#34;&gt;用意するもの&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Nefry BT&lt;/li&gt;
&lt;li&gt;IFTTTのアカウント&lt;/li&gt;
&lt;li&gt;LINEのアカウント&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;筆者の環境&#34;&gt;筆者の環境&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Nefry BT library Version 0.6.1&lt;/li&gt;
&lt;li&gt;Windows 10&lt;/li&gt;
&lt;li&gt;Arduino IDE 1.8.2&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;注意&#34;&gt;注意&lt;/h4&gt;

&lt;p&gt;Nefry BTは開発中のため、実際のコードや画面と異なる可能性があります。&lt;/p&gt;

&lt;h3 id=&#34;iftttにレシピを作成する&#34;&gt;IFTTTにレシピを作成する&lt;/h3&gt;

&lt;p&gt;IFTTTは様々なWebサービス同士を簡単に連携できるサービスです。連携したものは「レシピ」と呼ばれ、自分で新しいレシピを作成することもできます。今回はNefry BTとLINEを連携するレシピを作ってみます。&lt;/p&gt;

&lt;p&gt;アカウントを持っていない場合は下記の記事を参考にアカウントを取得してください。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;参考: &lt;a href=&#34;https://liginc.co.jp/263899&#34;&gt;Webサービス同士を連携できる「IFTTT」と自作IoTデバイスを繋いで生活を便利にしてみた&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;アカウントを取得したら、Nefry BTとLINEを連携させるレシピを登録していきましょう。&lt;/p&gt;

&lt;p&gt;IFTTTのレシピは「〇〇が起きたら△△する」というようにトリガーとアクションに分けられます。今回のトリガーは「&lt;strong&gt;Nefry BTのスイッチをクリックしたら&lt;/strong&gt;」、アクションは「&lt;strong&gt;LINEに通知する&lt;/strong&gt;」となります。&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;トリガーとnefry-btを紐付けるキーの取得&#34;&gt;トリガーとNefry BTを紐付けるキーの取得&lt;/h4&gt;

&lt;p&gt;今回はトリガーとして自作のWebサービスを利用できる「Webhooks」を使います。&lt;/p&gt;

&lt;p&gt;まずはWebhooksをあとでNefry BTと紐付けるために、Secret Keyというキーを取得します。&lt;a href=&#34;https://ifttt.com/discover&#34;&gt;IFTTT公式サイト&lt;/a&gt;上部の「Search」から、Webhooksを検索しクリックしましょう。（&amp;rdquo;web&amp;rdquo;で候補に出てきます。）
&lt;img src=&#34;https://dotstud.io/img/blog/100/if1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;設定ページに移動しました。このとき初めての方はこのような認証画面が表示されます。ページ中央の「Connect」をクリックしてWebhooksを有効にしましょう。
&lt;img src=&#34;https://dotstud.io/img/blog/100/if2.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Settingをクリックし、移動します。
&lt;img src=&#34;https://dotstud.io/img/blog/100/if3.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;アカウントごとに割り当てられるSecret KeyがURLのuse/以下に記載されているのでコピーしておきます。今回の例ではSecret Keyは &lt;code&gt;GnzpClq0nDwt4WEdTyTmt&lt;/code&gt; の部分です。（このSecret Keyはサンプルです。既に無効になっていますので自身で取得してください。）
&lt;img src=&#34;https://dotstud.io/img/blog/100/if4.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;トリガーの作成&#34;&gt;トリガーの作成&lt;/h4&gt;

&lt;p&gt;続いてトリガーとなるWebhooksの詳細を作成します。
&lt;img src=&#34;https://dotstud.io/img/blog/100/06_ifttt5.png&#34; alt=&#34;&#34; /&gt;
&lt;a href=&#34;https://ifttt.com/create&#34;&gt;IFTTTのレシピ作成ページ&lt;/a&gt;から、「+this」のリンクをクリックします。&lt;/p&gt;

&lt;p&gt;「Choose a service」から再度Webhooksを検索しましょう。
&lt;img src=&#34;https://dotstud.io/img/blog/100/if5.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;WebhooksはEventという単位でトリガーとなります。今回はEvent Nameを&amp;rdquo;Nefry&amp;rdquo;とし、「Create trigger」をクリックし作成します。Event NameはあとでNefry BTにも同じ名前で入力します。
&lt;img src=&#34;https://dotstud.io/img/blog/100/if6.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&#34;アクションの作成&#34;&gt;アクションの作成&lt;/h4&gt;

&lt;p&gt;最後に、トリガーが生じた時に起こすアクションを登録します。
&lt;img src=&#34;https://dotstud.io/img/blog/100/09_ifttt8.png&#34; alt=&#34;&#34; /&gt;
「+that」のリンクをクリックして、検索欄からLINEを検索しましょう。ここでTwitterやGmailなどを選択すると、それぞれのサービスと連携させることが出来ます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/100/10_ifttt9.png&#34; alt=&#34;&#34; /&gt;
Recipientと書かれた欄にメッセージを送るLINEの送信先を選択します。&lt;/p&gt;

&lt;p&gt;Messageと書かれた欄には送信するメッセージを入力します。MessageのValueにはプログラムから値を渡すことができるので、温度センサや明るさセンサなどの値をメッセージに組み込むことが可能です。写真のURLがあれば写真を送信することもできます。&lt;/p&gt;

&lt;p&gt;入力が完了したら、Create actionをクリックして保存します。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/100/11_ifttt10.png&#34; alt=&#34;&#34; /&gt;
最後にFinishを押し、IFTTTのレシピの作成は完了です。&lt;/p&gt;

&lt;h3 id=&#34;開発環境-arduino-ide-を整える&#34;&gt;開発環境（Arduino IDE）を整える&lt;/h3&gt;

&lt;p&gt;続いてNefy BTにプログラムを書く環境を整えます。プログラムの書き込みにはArduino IDEと呼ばれるエディタを使用します。&lt;a href=&#34;https://www.arduino.cc/en/Main/Software&#34;&gt;公式サイト&lt;/a&gt;からダウンロードし、以下の手順でNefry BT用の設定を追加してください。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/100/12_program.png&#34; alt=&#34;&#34; /&gt;
Arduino IDEの「環境設定」のページから、「追加のボードマネージャのURL」に以下のリンクを入力して検索します。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;https://nefry.studio/package_nefrybt_index.json&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;メニューバーの[ツール]から、[ボード] -&amp;gt; [ボードマネージャー]を選択します。選択肢に「Nefry by Nefry Community」が表示されているので、インストールします。
&lt;img src=&#34;https://dotstud.io/img/blog/100/13_library.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;これでプログラムを書き込む準備が整いました。&lt;/p&gt;

&lt;h3 id=&#34;プログラムを書き込む&#34;&gt;プログラムを書き込む&lt;/h3&gt;

&lt;p&gt;以下はNefry BTに搭載されている「スイッチ」を押したときにIFTTTのEventを呼ぶプログラムです。&lt;/p&gt;

&lt;p&gt;Arduino IDEを開き、以下のコードを貼り付けます。（//以降の部分はコメントです。）&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-cpp:&#34;&gt;#include &amp;lt;Nefry.h&amp;gt;
#include &amp;lt;NefryIFTTT.h&amp;gt;
String Event, SecretKey;
int counter =0;                       //送信データのカウンタ

void setup() {
  Nefry.setStoreTitle(&amp;quot;SecretKey&amp;quot;,0); //Nefry DataStoreのタイトルを指定
  Nefry.setStoreTitle(&amp;quot;Event&amp;quot;,1);     //Nefry DataStoreのタイトルを指定
  SecretKey = Nefry.getStoreStr(0);   //Nefry DataStoreからデータを取得
  Event = Nefry.getStoreStr(1);       //Nefry DataStoreからデータを取得
  Nefry.enableSW();                   //SW有効化
}

void loop() {
  if (Nefry.readSW()) {               //SWを押した時
    counter++;                        //送信回数加算
    bool sendData = IFTTT.send(Event, SecretKey,&amp;quot;Nefry&amp;quot;,(String)(micros()/1000000)+&amp;quot;秒&amp;quot;,(String)counter);//IFTTTにデータを送信
                                      //Value1:Nefry,Value2:Nefryが起動してからの秒数,Value3:送信カウンタ
    if (!sendData) {//IFTTTにデータを送信が成功したか失敗したかの判定
      Nefry.setLed(255, 0, 0);        //Errの時、赤色点灯
    }
    Nefry.ndelay(1000);               //送信後1秒間待つ
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;貼り付けできたら[ツール] -&amp;gt; [ボード]から「Nefry BT」を選択します。Nefry BTとPCを繋ぎ、[ツール] -&amp;gt; [シリアルポート]でNefry BTのシリアルポートを選択しましょう。
&lt;img src=&#34;https://dotstud.io/img/blog/100/14_arduinoide.png&#34; alt=&#34;&#34; /&gt;
ボードとシリアルポートを選んだらArduino IDEの左上にある「→」を押しプログラムを書き込みます。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/100/15_arduinoide2.png&#34; alt=&#34;&#34; /&gt;
「ボードへの書き込みが完了しました。」と表示されたら、Nefry BTへのプログラムの書き込みは完了です。&lt;/p&gt;

&lt;p&gt;最後にNefry BTにIFTTTとの連携情報を入力します。あと少しですので頑張っていきましょう！&lt;/p&gt;

&lt;h3 id=&#34;nefry-btとiftttを紐付ける&#34;&gt;Nefry BTとIFTTTを紐付ける&lt;/h3&gt;

&lt;p&gt;Nefry BTから&amp;rdquo;Nefry-OOOO&amp;rdquo;というWi-Fiの信号が発信されているので接続します。
&lt;img src=&#34;https://dotstud.io/img/blog/100/16_wifi.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;接続できたらChromeやIEなどのWebブラウザで&lt;a href=&#34;http://192.168.4.1&#34;&gt;Nefry BTのサイト&lt;/a&gt;にアクセスしましょう。&lt;code&gt;http://192.168.4.1&lt;/code&gt;にアクセスするとNefry BTの設定サイトが表示されます。このページからNefry BTに関する様々な設定ができます。
&lt;img src=&#34;https://dotstud.io/img/blog/100/17_nefry.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;まずは「Setup WiFi」をクリックし、Wi-Fiの設定をしましょう。
&lt;img src=&#34;https://dotstud.io/img/blog/100/18_nefry.png&#34; alt=&#34;&#34; /&gt;
接続するWi-Fiを入力して「Save」をクリックすると、Nefry BTに設定を保存＆再起動します。Wi-Fiが切断したら再接続してください。&lt;/p&gt;

&lt;p&gt;設定が完了したら、トップページに戻り「Data Store」のページに移動します。
&lt;img src=&#34;https://dotstud.io/img/blog/100/19_nefry.png&#34; alt=&#34;&#34; /&gt;
SecretKeyにはWebhooksで確認した値を、EventにはLINEと連携した際に入力したEvent Name（今回は”Nefry”）を入力します。Saveをクリックし値を保存するとNefry BTが再起動します。&lt;/p&gt;

&lt;p&gt;いよいよNefry BTについているスイッチを押してLINEにメッセージを送ってみましょう！&lt;/p&gt;

&lt;h3 id=&#34;スイッチを押してlineにメッセージを送ってみる&#34;&gt;スイッチを押してLINEにメッセージを送ってみる&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://dotstud.io/img/blog/100/20_nefry.gif&#34; alt=&#34;&#34; /&gt;
Nefry BTのスイッチを押すとLEDの色が変わり送信を始めます。送信が完了するとLEDが水色になり、LINEに通知されました！IFTTTのサーバ状態により応答が悪い場合もありますが、その時はIFTTTのページにてリロードをすると反応してくれます。&lt;/p&gt;

&lt;p&gt;初回は登録が多く時間がかかりますが、今後はサクっと作れるでしょう。&lt;/p&gt;

&lt;h2 id=&#34;さいごに&#34;&gt;さいごに&lt;/h2&gt;

&lt;p&gt;半田付けや複雑な設定なしで、ハードウェアをきっかけにしてLINEへメッセージを投稿する連携をサクッと試すことができました。今回紹介したNefry BTとIFTTTの連携を応用すればTwitterやGmailなどにもメッセージを送信できます。&lt;/p&gt;

&lt;p&gt;リアルタイム通信が得意な「Milkcocoa」やクラウドサービスMicrosoft AzureのIoT向け機能である「Azure IoT Hub」などを使うとより幅広い開発ができるでしょう。&lt;/p&gt;

&lt;p&gt;今後の更新で簡単に接続できるライブラリやサンプルコードを追加していく予定です。生まれたばかりでまだまだヒヨッコですが、進化していくNefry BTを応援していただけたらと思います。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>