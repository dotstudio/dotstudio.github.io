<!doctype html><html lang=ja><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="JavaScriptコードを用いてマイコン上で動作させるライブラリー「Moddable SDK」を使ってIoT開発をしてみました！"><meta name=author content="dotstudio Inc."><meta content="https://dotstud.io/img/blog/237/00_eyecatch.png"><meta itemprop=name content="Moddable SDKを使ってJavaScriptでIoT開発してみた | dotstudio"><meta itemprop=image content="https://dotstud.io/img/blog/237/00_eyecatch.png"><meta property="og:title" content="Moddable SDKを使ってJavaScriptでIoT開発してみた | dotstudio"><meta property="og:locale" content="ja_JP"><meta property="og:type" content="article"><meta property="og:url" content="https://dotstud.io/blog/developed-iot-using-moddable/"><meta property="og:site_name" content="dotstudio（ドットスタジオ）"><meta property="og:image" content="https://dotstud.io/img/blog/237/00_eyecatch.png"><meta property="og:image:secure_url" content="https://dotstud.io/img/blog/237/00_eyecatch.png"><meta property="og:description" content="JavaScriptコードを用いてマイコン上で動作させるライブラリー「Moddable SDK」を使ってIoT開発をしてみました！"><meta property="article:author" content="https://www.facebook.com/dotstud10/"><meta property="fb:app_id" content="296336307370435"><meta property="fb:pages" content="1013196712108753"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://dotstud.io/img/blog/237/00_eyecatch.png"><meta name=twitter:site content="@dotstud_io"><meta name=twitter:url content="https://dotstud.io/blog/developed-iot-using-moddable/"><meta name=twitter:description content="JavaScriptコードを用いてマイコン上で動作させるライブラリー「Moddable SDK」を使ってIoT開発をしてみました！"><meta name=twitter:title content="Moddable SDKを使ってJavaScriptでIoT開発してみた | dotstudio"><meta name=twitter:creator content="@dotstud_io"><meta name=google-site-verification content="oW2fcSG1fFnkDoRCGFJ0IGGebtBr8FjV2twoFMd7Skc"><title>Moddable SDKを使ってJavaScriptでIoT開発してみた | dotstudio</title><link rel=stylesheet href=/css/loader.css><link rel=stylesheet href=/css/master.css><link rel=stylesheet href=/css/icon-font.css><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel="shortcut icon" type=image/png href=/img/resources/favicon.png><link href=//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css rel=preload as=style onload="this.rel='stylesheet'"><link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=preload as=style onload="this.rel='stylesheet'"><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=preload as=style onload="this.rel='stylesheet'"><link href=/css/lib/hljs.css rel=preload as=style onload="this.rel='stylesheet'"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-K5TRM9Q');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-5922216421588455",enable_page_level_ads:true});</script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K5TRM9Q" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div id=fb-root></div><script>(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.8";fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><header><svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="icon-arrow-right" viewBox="0 0 32 32"><title>arrow-right</title><path class="path1" fill="none" stroke="#000" stroke-width="4.5714" stroke-miterlimit="4" stroke-linecap="square" stroke-linejoin="miter" d="M5.143 5.143l10.349 10.349"/><path class="path2" fill="none" stroke="#000" stroke-width="4.5714" stroke-miterlimit="4" stroke-linecap="square" stroke-linejoin="miter" d="M5.143 26.857l10.349-10.349"/><path class="path3" fill="none" stroke="#000" stroke-width="4.5714" stroke-miterlimit="4" stroke-linecap="square" stroke-linejoin="miter" d="M16.571 26.857 26.92 16.508"/><path class="path4" fill="none" stroke="#000" stroke-width="4.5714" stroke-miterlimit="4" stroke-linecap="square" stroke-linejoin="miter" d="M16.571 5.143 26.92 15.492"/></symbol><symbol id="icon-hamburger" viewBox="0 0 60 32"><title>hamburger</title><path class="path1" fill="none" stroke="gray" stroke-width="7.1111" stroke-miterlimit="4" stroke-linecap="square" stroke-linejoin="miter" d="M3.556 3.556h53.333"/><path class="path2" fill="none" stroke="gray" stroke-width="7.1111" stroke-miterlimit="4" stroke-linecap="square" stroke-linejoin="miter" d="M3.556 28.444h53.333"/></symbol><symbol id="icon-logo-mark" viewBox="0 0 32 32"><title>logo-mark</title><path class="path1" d="M19.731 28.8H0v-19.699h19.731zM1.53 27.302h16.672v-16.672h-16.672z"/><path class="path2" d="M32 22.899h-19.731v-19.699H32zM13.798 21.37H30.47V4.698h-16.672z"/></symbol><symbol id="icon-social-facebook" viewBox="0 0 32 32"><title>social-facebook</title><path class="path1" d="M30.1.12h-28.46c-.974.011-1.76.804-1.76 1.78v28.46c0 .983.797 1.78 1.78 1.78h15.32v-12.4h-4.16v-4.82h4.16v-3.58c-.02-.179-.031-.386-.031-.596.0-3.203 2.597-5.8 5.8-5.8.152.0.302.006.45.017-.016-.001-.013-.001-.009-.001 1.3.0 2.582.073 3.844.214l-.155 4.286h-2.54c-2 0-2.36.96-2.36 2.36v3.1h4.76l-.62 4.8h-4.12v12.4h8.12c.983.0 1.78-.797 1.78-1.78v-28.44c0-.983-.797-1.78-1.78-1.78z"/></symbol><symbol id="icon-social-github" viewBox="0 0 32 32"><title>social-github</title><path class="path1" d="M16 .4c-.001.0-.002.0-.004.0-8.837.0-16 7.163-16 16 0 7.028 4.531 12.997 10.831 15.147.913.173 1.213-.307 1.213-.747s-.04-1.38-.04-2.8c-4.44 1.06-5.38-2-5.38-2-.308-.987-.937-1.798-1.763-2.33-1.477-1.01.103-.99.103-.99 1.055.144 1.941.76 2.451 1.624.607 1.039 1.701 1.715 2.953 1.715.6.0 1.164-.155 1.653-.428.062-.836.437-1.58 1.002-2.13-3.559-.401-7.279-1.781-7.279-8.001-.001-.032-.001-.069-.001-.106.0-1.621.624-3.096 1.645-4.198-.181-.526-.283-1.135-.283-1.769.0-.85.184-1.657.514-2.383s1.325-.404 4.385 1.676c1.199-.341 2.577-.537 4-.537s2.801.196 4.107.562c2.953-2.026 4.293-1.666 4.293-1.666.31.683.49 1.481.49 2.321.0.688-.121 1.348-.343 1.959 1.03 1.058 1.654 2.533 1.654 4.154.0.037.0.075-.001.112.0 6.134-3.74 7.494-7.3 7.894.685.69 1.108 1.641 1.108 2.69.0.088-.003.175-.009.261.001 2.128.001 3.848.001 4.368s.28.92 1.1.78c6.413-2.183 10.944-8.152 10.944-15.18.0-8.837-7.163-16-16-16-.015.0-.031.0-.046.0z"/></symbol><symbol id="icon-social-twitter" viewBox="0 0 32 32"><title>social-twitter</title><path class="path1" d="M10 29c.036.0.078.0.12.0 10.25.0 18.56-8.31 18.56-18.56.0-.042.0-.085.0-.127.0-.274.0-.554.0-.834 1.312-.959 2.414-2.113 3.289-3.431-1.07.454-2.347.82-3.686.984 1.293-.819 2.312-2.084 2.804-3.587-1.184.679-2.577 1.234-4.062 1.539-1.286-1.244-2.976-2.027-4.849-2.027-3.634.0-6.58 2.946-6.58 6.58.0.518.06 1.022.173 1.506-5.473-.309-10.286-2.887-13.523-6.813-.587.917-.919 2.059-.919 3.278.0 2.258 1.137 4.25 2.871 5.435-1.063-.025-2.07-.325-2.95-.822l.032.017c0 .027-.001.058-.001.09.0 3.163 2.239 5.803 5.218 6.423-.479.156-1.078.242-1.696.242-.432.0-.854-.042-1.263-.121.908 2.637 3.319 4.512 6.175 4.567-2.208 1.746-5.039 2.8-8.116 2.8-.013.0-.027.0-.04.0-.566-.018-1.104-.068-1.633-.149 2.897 1.868 6.353 2.984 10.068 3.009z"/></symbol></defs></svg><div class=header><span class=logo><a href=/><svg id="icon-logo"><use xlink:href="#icon-logo-mark"/></a></span><div class=menu><input type=checkbox id=menu-toggle>
<label for=menu-toggle class=label-toggle><svg class="icon-hamburger"><use xlink:href="#icon-hamburger"/></label></input><ul><li class=menu-item><a href=/blog>Blog</a></li><li class=menu-item><a href=/docs>Docs</a></li><li class=menu-item><a href=/shop>Shop</a></li><li class=menu-item><a href=/members>Members</a></li><li class=menu-item><a href=/service>Service</a></li><li class=menu-item><a href=/about>About</a></li></ul></div></div></header><ul class=categories><li><a href=/categories/try/ class=selected>やってみるIoT</a></li><li><a href=/categories/learn/>IoTを知ろう</a></li><li><a href=/categories/event/>イベントレポート</a></li><li><a href=/categories/tips/>Tips</a></li></ul><article class=blog-single><div class=date>2019.01.24</div><img class=blog-single--eyecatch src=/img/blog/237/00_eyecatch.png alt width=710px><h1 class=blog-single--title>Moddable SDKを使ってJavaScriptでIoT開発してみた</h1><div class=blog-single--information><a class=author href=/members/horihiro><img src=/img/members/horihiro/author.png alt class=author--avatar><p class=author--name>ほりひろ</p></a><a class=series href=/series/nodejs>Node.js Magazine</a></div><div id=fb-root></div><script>(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src='https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v3.1&appId=172686636611828&autoLogAppEvents=1';fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><div class=share><a href=https://twitter.com/share class=twitter-share-button data-size=large data-show-count=true data-hashtags=dotstudio>Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');</script>&nbsp;<div class=fb-share-button data-href=https://dotstud.io/blog/developed-iot-using-moddable/ data-layout=button_count data-size=large data-mobile-iframe=true><a target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdotstud.io%2Fblog%2Fmftokyo-2018-chantoku-report%2F&src=sdkpreparse" class=fb-xfbml-parse-ignore>シェア</a></div>&nbsp;
<a href=https://dotstud.io/blog/developed-iot-using-moddable/ class=hatena-bookmark-button data-hatena-bookmark-layout=basic-counter data-hatena-bookmark-height=30 title=このエントリーをはてなブックマークに追加><img src=https://b.st-hatena.com/images/entry-button/button-only@2x.png alt=このエントリーをはてなブックマークに追加 width=20 height=20 style=border:none></a><script type=text/javascript src=https://b.st-hatena.com/js/bookmark_button.js async></script>
&nbsp;<div class=line-it-button data-lang=ja data-type=share-c data-url=https://dotstud.io/blog/developed-iot-using-moddable/ style=display:none></div><script src=https://d.line-scdn.net/r/web/social-plugin/js/thirdparty/loader.min.js async defer></script></div><div class="blog-single--content markdown"><p>どうも。<a href=/members/horihiro>ほりひろ</a> です。
dotstudioブログでは、初めましてですね。</p><p>JavaScript や IoT が好きな、でも実は半田付けも抵抗値の計算もろくにできないレベルの週末プログラマーです。
普段は某クラウドベンダーのサポートエンジニアをしています。
よろしくお願いします。</p><p>Twitterアカウントは<a href=https://twitter.com/hori__hiro>こちら</a>です。</p><p>年末に自分の中で話題になっていた、<strong>Moddable SDK</strong>というものをようやく触ってみました。</p><h2 id=moddable-sdk--xs>Moddable SDK & XS</h2><h3 id=moddable-sdk>Moddable SDK</h3><p>Moddable SDK は、<strong>JavaScript コードを ESP32 や ESP8266 といったマイコン上で動作させるためのビルド環境やライブラリー群</strong>のこと、、、だと思います。</p><p>これは Moddable 社から提供されていますが、下記 GitHub リポジトリで公開されているので、無料で手に入れられます。</p><p><a href=https://github.com/Moddable-OpenSource/moddable>https://github.com/Moddable-OpenSource/moddable</a></p><h3 id=xs>XS</h3><p>XS は、<strong>Moddable SDK で生成される JavaScript ランタイム環境</strong> （ドキュメントには <strong>virtual machine</strong> と記載）で、なんと <a href=https://github.com/Moddable-OpenSource/moddable#modern-software-development-for-microcontrollers>ES2018 に 99% 以上準拠</a>しているらしいです。すごいですね！</p><p>※一部準拠していない部分は、注意事項として**<a href=https://github.com/Moddable-OpenSource/moddable/blob/public/documentation/xs/XS%20Conformance.md#caveat>こちら</a>**に記載されています。</p><p>これは<a href=http://www.moddable.com/XS7-TC-39.php>公式ドキュメント</a>にある画像です。「XS は一番小さい」って意味でしょうね。シャレてます。</p><p>ざっくりとした理解ですが、Moddable SDK のビルドツールで、自分が書いた JavaScript や C のソースコードと組み込みのクラスが含まれた XS を、一つのバイナリーにビルドし、マイコンに書き込んでいるようです。</p><p>これまで JavaScript でのマイコン制御というと、以前から ホスト PC とマイコンをシリアル接続し、ホストPC上の Node.js と Johnny-Five を使ってマイコンを制御する方法があり、最近では obniz の制御をネットワークを介して JavaScript などから行う方法がありますが、いずれもマイコンの外に JavaScript の実行環境を用意する必要があります。</p><p>一方で、Moddable SDK では、JavaScript 実行環境である XS がマイコン上で動作することができます。</p><p>この点は、<strong>これまでの実行環境とは大きく違うところですね！</strong></p><h2 id=heading>開発環境の構築</h2><p>基本的に、公式のリポジトリに記載された <a href=https://github.com/Moddable-OpenSource/moddable/blob/public/documentation/Moddable%20SDK%20-%20Getting%20Started.md>構築手順</a>通りに実施することで、ビルド ツールなどの環境が構築できます。</p><p>構築手順は macOS/Linux/Windows の各プラットフォーム向けにまとまっており、それぞれが、下記の 3 つのパートに分かれて記載されています。</p><ol><li><code>mcconfig</code> や <code>xsbug</code> などの開発ツールのビルド</li><li>ESP8266 向けの開発環境の構築</li><li>ESP32 向けの開発環境の構築</li></ol><p>いずれのプラットフォームでも 1. は必須ですが、2. と 3. は手持ちのボードに合わせて、どちらかを実施するだけでよいです。</p><p>私は Windows 用の環境構築をしましたが、Windows 向けの開発環境構築では、**Windows ネイティブのコマンドを使用することをお勧めします。**
WSL から <code>git clone</code> などをすると、<a href=https://github.com/Moddable-OpenSource/moddable/issues/110><strong>開発ツールがビルドできない</strong></a>ようで、これに丸一日ハマりました。</p><p>あと、ビルドツールの実行は、必ず<code>開発者コマンドプロンプト for VS2017</code> を起動し、そのコマンドプロンプトの中でしましょう。</p><h2 id=->サンプル コード</h2><p>マイコンのサンプルと言えば Lチカですが、手元に LED がなかったので、とりあえず ESP32 上での非同期実行を試してみます。</p><h3 id=heading-1>ファイルの用意</h3><p>プロジェクト ディレクトリに下記のような構造で、ファイルを作ります。</p><pre><code>.
├── esp
│   ├── console.c
│   └── console.js
├── main.js
└── manifest.json
</code></pre><h3 id=mainjs>main.js</h3><p>1 秒おきに <code>1</code> から <code>10</code> の数字を、1.5 秒おきに <code>a</code> から <code>z</code> の文字を、シリアル コンソールに出力するプログラムです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js:main.js data-lang=js:main.js><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Timer</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;timer&#39;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>console</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;console&#34;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a&#39;</span>;
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;z&#39;</span>;

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span>;
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;

<span style=color:#a6e22e>Timer</span>.<span style=color:#a6e22e>repeat</span>(() =&gt; {
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span>String(Date.<span style=color:#a6e22e>now</span>()).<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>15</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>i</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
  <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>10</span>) <span style=color:#f92672>?</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
}, <span style=color:#ae81ff>1000</span>);

<span style=color:#a6e22e>Timer</span>.<span style=color:#a6e22e>repeat</span>(() =&gt; {
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span>String(Date.<span style=color:#a6e22e>now</span>()).<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>15</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
  <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>z</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>:</span> String.<span style=color:#a6e22e>fromCharCode</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>charCodeAt</span>(<span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
}, <span style=color:#ae81ff>1500</span>);
</code></pre></div><p>Web ブラウザーや Node.js なら、定期的な処理を書くなら <code>setInterval</code> を使うところだと思いますが、Moddable SDK / XS では、グローバルに <code>setInterval</code> が定義されていません。</p><p>代わりに、<code>Timer</code> オブジェクトの <code>repeat</code> メソッドを使って、同じ処理が似たような感じで書くことができます。</p><pre><code class=language-js:browser&nodejs data-lang=js:browser&nodejs>setInterval(() =&gt; {
    :
}, 1000);
</code></pre><pre><code class=language-js:XS data-lang=js:XS>import Timer from 'timer';

Timer.repeat(() =&gt; {
    :
}, 1000);
</code></pre><h3 id=consolejs-consolec>console.js /console.c</h3><p>実は XS では <code>console</code> オブジェクトもないので、とりあえず、下記の JS ファイルと C ファイルで、シリアルコンソールに 1 行出力できるメソッドを定義しておきます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c:esp/console.js data-lang=c:esp/console.js><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Console</span> <span style=color:#960050;background-color:#1e0010>@</span> <span style=color:#e6db74>&#34;xs_console_destructor&#34;</span> {
  <span style=color:#a6e22e>constructor</span>() {
  }
  <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>log</span>() <span style=color:#960050;background-color:#1e0010>@</span> <span style=color:#e6db74>&#34;xs_console_log&#34;</span>
}
Object.<span style=color:#a6e22e>freeze</span>(<span style=color:#a6e22e>Console</span>.<span style=color:#a6e22e>prototype</span>);

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Console</span>;
</code></pre></div><p>JS ファイルはタダのラッパーで、処理本体は C ファイルで定義しています。
JS ファイル内で <code>@ ～</code> と書くと、C ファイルで宣言した関数とバインディングされます。
これは、XS 独自の実装のようです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c:esp/console.c data-lang=c:esp/console.c><span style=color:#75715e>#</span><span style=color:#75715e>include</span> <span style=color:#75715e>&#34;xsAll.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e></span><span style=color:#75715e>#</span><span style=color:#75715e>include</span> <span style=color:#75715e>&#34;xs.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>xs_console_destructor</span>(<span style=color:#66d9ef>void</span>)
{
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>xs_console_log</span>(xsMachine <span style=color:#f92672>*</span>the)
{
  <span style=color:#66d9ef>int</span> argc <span style=color:#f92672>=</span> xsToInteger(xsArgc), i;

  <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> argc; i<span style=color:#f92672>+</span><span style=color:#f92672>+</span>) {
    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>str <span style=color:#f92672>=</span> xsToString(xsArg(i));

    <span style=color:#66d9ef>do</span> {
      uint8_t c <span style=color:#f92672>=</span> c_read8(str);
      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>c) {
        ESP_putc(<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>\n</span><span style=color:#e6db74>&#39;</span>);
        <span style=color:#66d9ef>break</span>;
      }

      ESP_putc(c);

      str<span style=color:#f92672>+</span><span style=color:#f92672>+</span>;
    } <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>);
  }
}
</code></pre></div><h3 id=manifestjson>manifest.json</h3><p>最後は manifest ファイルです。
正直言うと、ここはあまり把握できていません :sweat:</p><p><code>include</code> で Moddable SDK で用意されている manifest を、ベースの manifest として読み込み、全プラットフォーム共通のモジュールとして <code>main</code>(.js) を、<code>esp32</code> 向けには、<code>./esp/console</code>(.js) をロードする設定を書いています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json:manifest.json data-lang=json:manifest.json>{
  <span style=color:#f92672>&#34;include&#34;</span>: <span style=color:#e6db74>&#34;$(MODDABLE)/examples/manifest_base.json&#34;</span>,
  <span style=color:#f92672>&#34;modules&#34;</span>: {
    <span style=color:#f92672>&#34;*&#34;</span>: [
      <span style=color:#e6db74>&#34;./main&#34;</span>,
    ]
  },
  <span style=color:#f92672>&#34;platforms&#34;</span>: {
    <span style=color:#f92672>&#34;esp32&#34;</span>: {
      <span style=color:#f92672>&#34;modules&#34;</span>: {
        <span style=color:#f92672>&#34;*&#34;</span>: [
          <span style=color:#e6db74>&#34;./esp/console&#34;</span>,
        ],
      }
    }
  },
}
</code></pre></div><p>上の <code>manifest.json</code> では <code>Timer</code> クラスをロードしていませんが、<code>main.js</code> では問題なく import することができます。
これは、Moddable SDK に含まれるベースの manifest でロード設定がされているためです。</p><pre><code class=language-json:$(MODDABLE)/examples/manifest_base.json(抜粋) data-lang=json:$(MODDABLE)/examples/manifest_base.json(抜粋)>{
  :
 (略)
  :
  &quot;platforms&quot;: {
    :
   (略)
    :
    &quot;esp32&quot;: {
      &quot;include&quot;: &quot;$(BUILD)/devices/esp32/manifest.json&quot;
    },
  }
  :
 (略)
  :
}
</code></pre><pre><code class=language-json:$(BUILD)/devices/esp32/manifest.json(抜粋) data-lang=json:$(BUILD)/devices/esp32/manifest.json(抜粋)>{
  :
 (略)
  :
  &quot;modules&quot;: {
    &quot;*&quot;: [
      &quot;$(MODULES)/base/time/*&quot;,
      &quot;$(MODULES)/base/time/esp/*&quot;,
      &quot;$(MODULES)/base/timer/*&quot;,
      &quot;$(MODULES)/base/timer/mc/*&quot;,
    ]
  },
  &quot;preload&quot;: [
    &quot;time&quot;,
    &quot;timer&quot;,
  ],
  :
 (略)
  :
}
</code></pre><p>ちなみに manifest についてツイートしたところ、公式アカウントからも返事がありました。</p><p><strong>ドキュメントは定期的にメンテナンスされそうです。</strong></p><h2 id=heading-2>実行してみる</h2><p><code>manifest.json</code> があるディレクトリで、<code>mcconfig</code> コマンドを実行します。
大抵は、XS のビルドから始まるので、書き込みが完了するまでだいぶ時間がかかると思います。</p><p>書き込みが完了すると、シリアルモニターに自動的に接続し、<code>console.log</code> の出力内容が表示されます。</p><pre><code>&gt; mcconfig -m -p esp32
rm: cannot remove '/root/Projects/moddable/build/tmp/esp32/release/xsProj/sdkconfig': No such file or directory
# Running GENCONFIG...
fatal: Not a git repository (or any of the parent directories): .git
including /root/esp32/esp-idf/components/bootloader/Makefile.projbuild...

   :
  (略)
   :

MONITOR
--- idf_monitor on /dev/ttyUSB0 115200 ---
--- Quit: Ctrl+] | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---
ets Jun  8 2016 00:22:57

rst:0x1 (POWERON_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)
configsip: 0, SPIWP:0xee
clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00
mode:DIO, clock div:2
load:0x3fff0018,len:4
load:0x3fff001c,len:636
load:0x40078000,len:6192
load:0x40080000,len:5152
0x40080000: _iram_start at /root/esp32/esp-idf/components/freertos/xtensa_vectors.S:1685

entry 0x40080264
0x40080264: _Level5Vector at ??:?

           1010:1
           1510:a
           2010:2
           3010:3
           3011:b
           4010:4
           4510:c
           5010:5
           6010:6
   :
  (略)
   :
</code></pre><p>指定した時間間隔で、コールバック関数が実行されています！
ES2017 で入った <code>String.prototype.padStart</code> も正常に動作しているようです。</p><p>なお、マイコンには時計がないので、<code>Date.now()</code> は起動時からの時間を返します。</p><h3 id=heading-3>デバッグ実行</h3><p>先ほど実行したコマンド <code>mcconfig -m -p esp32</code> にデバッグ オプション <code>-d</code> を追加すると、デバッグ ビルドを実行し、デバッグ ツールである <code>xsbug</code> が自動で起動します。</p><p>この <code>xsbug</code> は JavaScript コードにブレークポイントの設定や、ステップ実行、変数の内容などを表示することが
でき、結構本格的なデバッグツールです。</p><p>今は独自の GUI ツールとして提供されているようですが、そのうち<strong>VSCode から拡張機能として利用できるようになると嬉しいですね。</strong></p><h2 id=heading-4>まとめ</h2><p>いかがだったでしょうか。
Moddable SDK を使うことで、JavaScript で書いたコードを、ESP8266/32 で動作させることができました。</p><p>Web フロントエンドや Node.js など、JavaScript を書くエンジニア人口は多いでしょうから、そういった方々も気軽にマイコン開発ができるようになりますね。</p><p>あとは、manifest ファイルに関するドキュメントの整備がすすんだり、もう少し簡単に環境構築ができれば、格段に開発しやすくなるのではないでしょうか。</p></div><div class=share-foot><a href=https://twitter.com/share class=twitter-share-button data-size=large data-show-count=true data-hashtags=dotstudio>Tweet</a>
&nbsp;<div class=fb-share-button data-href=https://dotstud.io/blog/developed-iot-using-moddable/ data-layout=button_count data-size=large data-mobile-iframe=true><a target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdotstud.io%2Fblog%2Fmftokyo-2018-chantoku-report%2F&src=sdkpreparse" class=fb-xfbml-parse-ignore>シェア</a></div>&nbsp;
<a href=https://dotstud.io/blog/developed-iot-using-moddable/ class=hatena-bookmark-button data-hatena-bookmark-layout=basic-counter data-hatena-bookmark-height=30 title=このエントリーをはてなブックマークに追加><img src=https://b.st-hatena.com/images/entry-button/button-only@2x.png alt=このエントリーをはてなブックマークに追加 width=20 height=20 style=border:none></a>
&nbsp;<div class=line-it-button data-lang=ja data-type=share-c data-url=https://dotstud.io/blog/developed-iot-using-moddable/ style=display:none></div></div><nav class=related><h2>関連記事</h2><ul class=cards-related><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/pokio-nodered-keikyu-chien/><img class=card-related--thumbnail src=/img/blog/243/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>【どんと来い、列車遅延】 勤怠メールをサクッと送れるオレオレツールを作ってみた</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/cloudflare-cache-clear-nodejs/><img class=card-related--thumbnail src=/img/blog/242/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>CloudflareのAPIをNode.js+GitLab CIから実行してキャッシュクリアしてみよう</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/update-nefrybt-to-googledrive/><img class=card-related--thumbnail src=/img/blog/241/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>NefryBTからGoogleDriveにデータをアップロードする方法</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/gitlab-vuepress-custom-domain/><img class=card-related--thumbnail src=/img/blog/239/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>VuePressのブログをカスタムドメイン+SSL対応させたGitLab Pagesにデプロイする</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/face-robot-making-basic2/><img class=card-related--thumbnail src=/img/blog/240/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Let's 顔面製造！第二弾！ 歌うサンタ顔面ロボットを作ろう</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/arduino-nodejs-twitter-connect/><img class=card-related--thumbnail src=/img/blog/230/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>ArduinoでTwitter連携！愛しのぬいぐるみトンピーちゃんに命を吹き込んでみた</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/static-site-hosting-surge/><img class=card-related--thumbnail src=/img/blog/219/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>無料で手軽！コマンド一つで静的サイトホスティングできるSurgeを試してみた。</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/node-school-1-3/><img class=card-related--thumbnail src=/img/blog/157/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>NodeSchoolでNode.jsの学習を始めよう！#2 - 問題1〜3の解答と解説</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/node-school-before-learn/><img class=card-related--thumbnail src=/img/blog/156/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>NodeSchoolでNode.jsの学習を始めよう！インストール手順から基本操作までステップ別解説</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/how-to-use-cli/><img class=card-related--thumbnail src=/img/blog/158/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>【Mac向け】「黒い画面」の苦手意識を克服しよう！コマンドラインインタフェースの基本操作</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/gmail-api-from-nodejs/><img class=card-related--thumbnail src=/img/blog/150/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Google公式ライブラリを利用してNode.jsからGmailの送受信をしてみよう</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/nodejs-install-use-nodebrew/><img class=card-related--thumbnail src=/img/blog/136/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.jsを始めよう！nodebrewを使って5分で環境構築</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/google-spreadsheets-from-nodejs/><img class=card-related--thumbnail src=/img/blog/135/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.jsでGoogle SpreadSheetsを操作してみよう。【GAS不使用】</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/hexo-static-site-vol3/><img class=card-related--thumbnail src=/img/blog/108/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.js製の静的サイトジェネレータ「Hexo」で無料ブログ開発 vol.3</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/linedevday-report-2017-gatebox/><img class=card-related--thumbnail src=/img/blog/128/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>#linedevday 2017レポート！ Clova連携で期待のGateboxの技術話を聞いてみたよ</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/hexo-static-site-vol2/><img class=card-related--thumbnail src=/img/blog/107/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.js製の静的サイトジェネレータ「Hexo」で無料ブログ開発 vol.2</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/hexo-static-site-vol1/><img class=card-related--thumbnail src=/img/blog/105/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.js製の静的サイトジェネレータ「Hexo」で無料ブログ開発 vol.1</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/operate-mysql-from-nodejs/><img class=card-related--thumbnail src=/img/blog/068/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.jsアプリケーションからMySQLにアクセスする</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/nodejs-npm-chokidar-fswatch/><img class=card-related--thumbnail src=/img/blog/035/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.jsでファイル監視を行うchokidarを使ってみよう</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/nodejs-hosting-services-2016/><img class=card-related--thumbnail src=/img/blog/061/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>2016年12月版　Node.jsをホスティング出来るPaaSまとめ</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/nodejs-npm-readline-sync/><img class=card-related--thumbnail src=/img/blog/024/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Node.jsでコマンドラインツール作るときに使いやすいreadline-sync</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/pepper-pokemon-go-notice/><img class=card-related--thumbnail src=/img/blog/017/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>Pokemon GOで近くにポケモンが出たらPepperが教えてくれる仕組みをNode.jsだけで作る</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/nodebots-kit-guide-vol1/><img class=card-related--thumbnail src=/img/blog/004/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>史上初!? NodeBotsの日本向けキットを作成しました！ #nodebots</h3></a></article></li><li class=js-items><article class=card-related><a href=https://dotstud.io/blog/nodebots-handson-report-vol2/><img class=card-related--thumbnail src=/img/blog/003/00_thumbnail.png alt=サムネイル><h3 class=card-related--title>今週末はInternational NodeBots Dayですよ！( #NodeBots vol2のイベレポと次回告知 )</h3></a></article></li></ul></nav></article><footer class=footer><p class=footer-info><a class=footer-info--item href=/about>会社概要</a>
<a class=footer-info--item href=/members>メンバー</a>
<a class=footer-info--item href=/recruit>採用情報</a>
<a class=footer-info--item href=/legal#tos>利用規約</a>
<a class=footer-info--item href=/legal#sct>特定商取引</a>
<a class=footer-info--item href=/legal#pp>プライバシーポリシー</a></p><p class=footer-cr>© 2018 dotstudio inc.</p></footer><script src=/js/jquery.min.js></script><script src=/js/app.js></script><script src=/js/lib/hljs.js></script><script src=/js/lib/hljs-numbers.js></script><script>hljs.initHighlightingOnLoad();hljs.initLineNumbersOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-78080011-1','auto');ga('send','pageview');</script></body>